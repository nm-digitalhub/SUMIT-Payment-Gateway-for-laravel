@php
    /**
     * Public Checkout Page View - FIXED VERSION
     * 
     * Changes from original:
     * 1. Added Progress Stepper (RTL)
     * 2. Added Trust Badges row
     * 3. Fixed RTL column order (Payment on right)
     * 4. Changed CTA color to green (#4AD993)
     * 5. Updated input styling
     * 6. Added trust section with checkmarks
     * 7. Improved Hebrew translations
     */
    $rtl = app()->getLocale() === 'he' || app()->getLocale() === 'ar';
    $amount = $payable->getPayableAmount();
    $items = $payable->getLineItems();
    $shipping = $payable->getShippingAmount();
    $fees = $payable->getFees();
    $user = auth()->user();
    if (!$user && class_exists(\Filament\Facades\Filament::class)) {
        $user = \Filament\Facades\Filament::auth()->user();
    }
    $client = $user?->client;

    $customerName = $prefillName ?? $payable->getCustomerName() ?? ($client->name ?? null) ?? ($user ? trim(($user->first_name ?? '') . ' ' . ($user->last_name ?? '')) ?: $user->name : null);
    $customerEmail = $prefillEmail ?? $payable->getCustomerEmail() ?? ($client->email ?? null) ?? ($user->email ?? null);
    $customerPhone = $prefillPhone ?? $payable->getCustomerPhone() ?? ($client->phone ?? null) ?? ($user->phone ?? null);
    $customerCitizenId = $prefillCitizenId ?? ($user->id_number ?? $user->vat_number ?? null) ?? ($client->id_number ?? $client->vat_number ?? null);
    $customerCompany = $prefillCompany ?? $client->company ?? $user->company ?? null;
    $customerVat = $prefillVat ?? $client->vat_number ?? $user->vat_number ?? null;
    $customerAddress = $prefillAddress ?? $client->client_address ?? $client->address ?? null;
    $customerAddress2 = $prefillAddress2 ?? $client->client_address2 ?? null;
    $customerCity = $prefillCity ?? $client->client_city ?? $client->city ?? null;
    $customerState = $prefillState ?? $client->client_state ?? $client->state ?? null;
    $customerCountry = $prefillCountry ?? $client->client_country ?? $client->country ?? 'IL';
    $customerPostal = $prefillPostal ?? $client->client_postal_code ?? $client->postal_code ?? null;
    
    // Current step (can be dynamic based on form state)
    $currentStep = 1;
@endphp

<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}" dir="{{ $rtl ? 'rtl' : 'ltr' }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    
    <title>{{ __('Checkout') }} - {{ config('app.name') }}</title>
    
    {{-- Fonts --}}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    {{-- App styles via Vite --}}
    @vite(['resources/css/app.css'])
    
    {{-- jQuery (required by SUMIT PaymentsJS) --}}
    @if($settings['pci_mode'] === 'no')
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://app.sumit.co.il/scripts/payments.js"></script>
    @endif
    
    <style>
        [x-cloak] { display: none !important; }
        
        body {
            font-family: 'Heebo', sans-serif;
        }
        
        /* Custom Focus Ring */
        *:focus-visible {
            outline: 2px solid #4AD993;
            outline-offset: 2px;
        }
        
        /* RTL Input Adjustments */
        input[dir="ltr"], 
        input[type="email"], 
        input[type="tel"],
        input[type="number"] {
            text-align: left;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F8F9FF; }
        ::-webkit-scrollbar-thumb { background: #E9E9E9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #8890B1; }
    </style>
    
    @stack('styles')
</head>
<body class="bg-[#F8F9FF] min-h-screen">
    <div class="py-8 px-4" x-data="checkoutPage()" :dir="rtl ? 'rtl' : 'ltr'">
        <div class="max-w-6xl mx-auto">
            
            {{-- ========================================= --}}
            {{-- NEW: Progress Stepper (RTL) - Tailwind v4 Optimized --}}
            {{-- ========================================= --}}
            <nav aria-label="Checkout progress" class="bg-white rounded-2xl shadow-sm p-4 sm:p-6 mb-6">
                <ol class="flex items-center justify-center" role="list">
                    @if($rtl)
                        {{-- RTL Order: 4 → 3 → 2 → 1 (right to left) --}}
                        {{-- Step 4: הגשה --}}
                        <li class="flex flex-col items-center gap-2" aria-current="{{ $currentStep === 4 ? 'step' : 'false' }}">
                            <div class="size-10 sm:size-12 rounded-full border-2 {{ $currentStep >= 4 ? 'bg-[#4AD993] border-[#4AD993] text-white' : 'border-gray-300 text-gray-400' }} flex items-center justify-center transition-colors duration-200">
                                <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                </svg>
                            </div>
                            <span class="text-xs sm:text-sm {{ $currentStep >= 4 ? 'font-medium text-[#4AD993]' : 'text-gray-400' }}">{{ __('Submit') }}</span>
                        </li>

                        <div class="w-8 sm:w-12 md:w-20 h-0.5 {{ $currentStep >= 4 ? 'bg-[#4AD993]' : 'bg-gray-200' }} mx-1 sm:mx-2 transition-colors duration-200" aria-hidden="true"></div>

                        {{-- Step 3: תנאים --}}
                        <li class="flex flex-col items-center gap-2" aria-current="{{ $currentStep === 3 ? 'step' : 'false' }}">
                            <div class="size-10 sm:size-12 rounded-full {{ $currentStep >= 3 ? 'bg-[#4AD993] text-white' : 'border-2 border-gray-300 text-gray-400' }} flex items-center justify-center text-sm font-medium transition-colors duration-200">3</div>
                            <span class="text-xs sm:text-sm {{ $currentStep >= 3 ? 'font-medium text-[#4AD993]' : 'text-gray-400' }}">{{ __('Terms') }}</span>
                        </li>

                        <div class="w-8 sm:w-12 md:w-20 h-0.5 {{ $currentStep >= 3 ? 'bg-[#4AD993]' : 'bg-gray-200' }} mx-1 sm:mx-2 transition-colors duration-200" aria-hidden="true"></div>

                        {{-- Step 2: תשלום --}}
                        <li class="flex flex-col items-center gap-2" aria-current="{{ $currentStep === 2 ? 'step' : 'false' }}">
                            <div class="size-10 sm:size-12 rounded-full {{ $currentStep >= 2 ? 'bg-[#4AD993] text-white' : 'border-2 border-gray-300 text-gray-400' }} flex items-center justify-center text-sm font-medium transition-colors duration-200">2</div>
                            <span class="text-xs sm:text-sm {{ $currentStep >= 2 ? 'font-medium text-[#4AD993]' : 'text-gray-400' }}">{{ __('Payment') }}</span>
                        </li>

                        <div class="w-8 sm:w-12 md:w-20 h-0.5 {{ $currentStep >= 2 ? 'bg-[#4AD993]' : 'bg-gray-200' }} mx-1 sm:mx-2 transition-colors duration-200" aria-hidden="true"></div>

                        {{-- Step 1: פרטי לקוח (Active) --}}
                        <li class="flex flex-col items-center gap-2" aria-current="{{ $currentStep === 1 ? 'step' : 'false' }}">
                            <div class="size-10 sm:size-12 rounded-full {{ $currentStep >= 1 ? 'bg-[#4AD993] text-white' : 'border-2 border-gray-300 text-gray-400' }} flex items-center justify-center text-sm font-medium transition-colors duration-200">1</div>
                            <span class="text-xs sm:text-sm {{ $currentStep >= 1 ? 'font-medium text-[#4AD993]' : 'text-gray-400' }}">{{ __('Customer') }}</span>
                        </li>
                    @else
                        {{-- LTR Order: 1 → 2 → 3 → 4 (left to right) --}}
                        <li class="flex flex-col items-center gap-2" aria-current="{{ $currentStep === 1 ? 'step' : 'false' }}">
                            <div class="size-10 sm:size-12 rounded-full bg-[#4AD993] text-white flex items-center justify-center text-sm font-medium transition-colors duration-200">1</div>
                            <span class="text-xs sm:text-sm font-medium text-[#4AD993]">{{ __('Customer') }}</span>
                        </li>

                        <div class="w-8 sm:w-12 md:w-20 h-0.5 bg-[#4AD993] mx-1 sm:mx-2 transition-colors duration-200" aria-hidden="true"></div>

                        <li class="flex flex-col items-center gap-2" aria-current="{{ $currentStep === 2 ? 'step' : 'false' }}">
                            <div class="size-10 sm:size-12 rounded-full border-2 border-gray-300 text-gray-400 flex items-center justify-center text-sm font-medium transition-colors duration-200">2</div>
                            <span class="text-xs sm:text-sm text-gray-400">{{ __('Payment') }}</span>
                        </li>

                        <div class="w-8 sm:w-12 md:w-20 h-0.5 bg-gray-200 mx-1 sm:mx-2 transition-colors duration-200" aria-hidden="true"></div>

                        <li class="flex flex-col items-center gap-2" aria-current="{{ $currentStep === 3 ? 'step' : 'false' }}">
                            <div class="size-10 sm:size-12 rounded-full border-2 border-gray-300 text-gray-400 flex items-center justify-center text-sm font-medium transition-colors duration-200">3</div>
                            <span class="text-xs sm:text-sm text-gray-400">{{ __('Terms') }}</span>
                        </li>

                        <div class="w-8 sm:w-12 md:w-20 h-0.5 bg-gray-200 mx-1 sm:mx-2 transition-colors duration-200" aria-hidden="true"></div>

                        <li class="flex flex-col items-center gap-2" aria-current="{{ $currentStep === 4 ? 'step' : 'false' }}">
                            <div class="size-10 sm:size-12 rounded-full border-2 border-gray-300 text-gray-400 flex items-center justify-center transition-colors duration-200">
                                <svg class="size-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                </svg>
                            </div>
                            <span class="text-xs sm:text-sm text-gray-400">{{ __('Submit') }}</span>
                        </li>
                    @endif
                </ol>
                <p class="text-center text-xs sm:text-sm text-gray-400 mt-3 sm:mt-4" role="status" aria-live="polite">{{ __('Step :current of :total', ['current' => $currentStep, 'total' => 4]) }}</p>
            </nav>

            {{-- ========================================= --}}
            {{-- NEW: Trust Badges - Tailwind v4 Optimized --}}
            {{-- ========================================= --}}
            <div class="flex flex-wrap items-center justify-center gap-2 sm:gap-3 mb-6" role="list" aria-label="Security features">
                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-full shadow-sm hover:shadow-md transition-shadow duration-200" role="listitem">
                    <svg class="size-4 text-green-500 shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-xs sm:text-sm text-gray-600 font-medium">{{ __('SSL Encrypted') }}</span>
                </div>

                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-full shadow-sm hover:shadow-md transition-shadow duration-200" role="listitem">
                    <svg class="size-4 text-green-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="text-xs sm:text-sm text-gray-600 font-medium">{{ __('PCI DSS Compliant') }}</span>
                </div>

                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-full shadow-sm hover:shadow-md transition-shadow duration-200" role="listitem" aria-label="Accepted payment cards">
                    <span class="text-blue-700 font-bold text-xs">VISA</span>
                    <span class="text-orange-500 font-bold text-xs">MC</span>
                    <span class="text-blue-500 font-bold text-xs">AMEX</span>
                </div>

                @if($bitEnabled)
                <div class="flex items-center gap-2 bg-white px-3 py-2 rounded-full shadow-sm hover:shadow-md transition-shadow duration-200" role="listitem" aria-label="Bit payment available">
                    <span class="text-blue-600 font-bold text-sm">Bit</span>
                </div>
                @endif
            </div>
            
            {{-- Header --}}
            <div class="text-center mb-8">
                <div class="flex items-center justify-between mb-4">
                    {{-- Accessibility Button --}}
                    <button class="bg-white p-3 rounded-xl shadow-sm hover:shadow-md transition-shadow" title="{{ __('Accessibility') }}">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                    </button>

                    <h1 class="text-2xl md:text-3xl font-bold text-[#111928]">{{ __('Complete your purchase') }}</h1>

                    {{-- Language Selector - Matches Accessibility Button Style --}}
                    @include('officeguy::pages.partials.language-selector-inline')
                </div>
                <p class="text-[#8890B1] text-sm md:text-base">
                    {{ __('Secure payment with instant delivery. Your card details are encrypted and never stored.') }}
                </p>
            </div>
            
            {{-- ========================================= --}}
            {{-- FIXED: RTL Layout - Payment on Right --}}
            {{-- ========================================= --}}
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                
                {{-- ========================================= --}}
                {{-- Payment Method Card (Right in RTL) --}}
                {{-- ========================================= --}}
                <div class="xl:col-span-1 {{ $rtl ? 'xl:order-2' : 'xl:order-3' }}">
                    <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                        {{-- Card Header with Gradient --}}
                        <div class="bg-gradient-to-{{ $rtl ? 'l' : 'r' }} from-[#E8F9F9] to-[#F0FDFD] p-4 border-b border-gray-100">
                            <div class="flex items-center {{ $rtl ? 'justify-between' : 'justify-between flex-row-reverse' }}">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-[#4BD0CC] font-medium">{{ __('Secure') }}</span>
                                    <svg class="w-4 h-4 text-[#4BD0CC]" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="flex items-center gap-3">
                                    <h2 class="text-lg font-semibold text-[#111928]">{{ __('Payment Method') }}</h2>
                                    <div class="w-8 h-8 bg-[#4BD0CC] rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <p class="text-sm text-[#8890B1] mt-1 {{ $rtl ? 'text-right' : 'text-left' }}">{{ __('Choose your preferred payment option') }}</p>
                        </div>
                        
                        {{-- Card Body --}}
                        <div class="p-6 space-y-5">
                            {{-- Payment Method Tabs --}}
                            @if($bitEnabled)
                            <div class="flex gap-3 mb-4">
                                <button 
                                    type="button"
                                    @click="paymentMethod = 'card'"
                                    :class="paymentMethod === 'card' ? 'border-[#4BD0CC] bg-[#E8F9F9] text-[#4BD0CC]' : 'border-gray-200 hover:border-gray-300'"
                                    class="flex-1 p-3 border-2 rounded-lg transition-colors text-center"
                                >
                                    <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                    </svg>
                                    <span class="text-sm font-medium">{{ __('Credit Card') }}</span>
                                </button>
                                
                                <button 
                                    type="button"
                                    @click="paymentMethod = 'bit'"
                                    :class="paymentMethod === 'bit' ? 'border-[#4BD0CC] bg-[#E8F9F9] text-[#4BD0CC]' : 'border-gray-200 hover:border-gray-300'"
                                    class="flex-1 p-3 border-2 rounded-lg transition-colors text-center"
                                >
                                    <span class="text-blue-600 font-bold text-lg block mb-1">Bit</span>
                                    <span class="text-sm font-medium">Bit</span>
                                </button>
                            </div>
                            @endif
                            
                            <input type="hidden" name="payment_method" x-model="paymentMethod">
                            
                            {{-- Credit Card Fields --}}
                            <div x-show="paymentMethod === 'card'" x-cloak class="space-y-4">
                                {{-- Saved Payment Methods --}}
                                @if($supportTokens && $savedTokens->isNotEmpty())
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-[#383E53] mb-2">{{ __('Saved Payment Methods') }}</label>
                                    <div class="space-y-2">
                                        @foreach($savedTokens as $token)
                                        <label class="flex items-center p-3 border border-[#E9E9E9] rounded-lg cursor-pointer hover:bg-[#F8F9FF] transition-colors">
                                            <input type="radio" name="payment_token" value="{{ $token->id }}" x-model="selectedToken" class="text-[#4AD993] focus:ring-[#4AD993]">
                                            <span class="{{ $rtl ? 'mr-3' : 'ml-3' }} flex-1">
                                                <span class="font-medium">{{ $token->getMaskedNumber() }}</span>
                                                <span class="text-[#8890B1] text-sm">({{ $token->expiry_month }}/{{ $token->expiry_year }})</span>
                                            </span>
                                        </label>
                                        @endforeach
                                        
                                        <label class="flex items-center p-3 border border-[#E9E9E9] rounded-lg cursor-pointer hover:bg-[#F8F9FF] transition-colors">
                                            <input type="radio" name="payment_token" value="new" x-model="selectedToken" class="text-[#4AD993] focus:ring-[#4AD993]">
                                            <span class="{{ $rtl ? 'mr-3' : 'ml-3' }} font-medium">{{ __('Use a new card') }}</span>
                                        </label>
                                    </div>
                                </div>
                                @endif
                                
                                {{-- New Card Fields --}}
                                <div x-show="selectedToken === 'new'" x-cloak class="space-y-4">
                                    {{-- Card Number --}}
                                    <div>
                                        <label for="og-ccnum" class="block text-sm font-medium text-[#383E53] mb-2 {{ $rtl ? 'text-right' : 'text-left' }}">
                                            {{ __('Card Number') }} <span class="text-[#FF7878]">*</span>
                                        </label>
                                        <div class="relative">
                                            <input 
                                                type="text" 
                                                id="og-ccnum" 
                                                name="card_number"
                                                data-og="cardnumber"
                                                x-model="cardNumber"
                                                dir="ltr"
                                                maxlength="19"
                                                inputmode="numeric"
                                                autocomplete="cc-number"
                                                placeholder="0000 0000 0000 0000"
                                                class="w-full bg-[#F2F4F7] border border-[#E9E9E9] rounded-lg px-4 py-3 {{ $rtl ? 'pl-10' : 'pr-10' }} text-[#383E53] text-left placeholder-[#8890B1] focus:ring-2 focus:ring-[#4AD993] focus:border-transparent transition-all"
                                            >
                                            <div class="absolute {{ $rtl ? 'left-3' : 'right-3' }} top-1/2 -translate-y-1/2">
                                                <svg class="w-5 h-5 text-[#8890B1]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                                                </svg>
                                            </div>
                                        </div>
                                        <p class="text-[#8890B1] text-xs mt-1 {{ $rtl ? 'text-right' : 'text-left' }}">{{ __('Enter 13-19 digits') }}</p>
                                    </div>
                                    
                                    {{-- Expiration & CVV --}}
                                    <div class="grid grid-cols-3 gap-3">
                                        <div>
                                            <label class="block text-sm font-medium text-[#383E53] mb-2 {{ $rtl ? 'text-right' : 'text-left' }}">{{ __('Month') }} <span class="text-[#FF7878]">*</span></label>
                                            <select 
                                                id="og-expmonth" 
                                                name="exp_month"
                                                data-og="expirationmonth"
                                                x-model="expMonth"
                                                class="w-full bg-[#F2F4F7] border border-[#E9E9E9] rounded-lg px-3 py-3 text-[#383E53] focus:ring-2 focus:ring-[#4AD993] focus:border-transparent transition-all"
                                            >
                                                <option value="">MM</option>
                                                @for($i = 1; $i <= 12; $i++)
                                                    <option value="{{ str_pad($i, 2, '0', STR_PAD_LEFT) }}">{{ str_pad($i, 2, '0', STR_PAD_LEFT) }}</option>
                                                @endfor
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-[#383E53] mb-2 {{ $rtl ? 'text-right' : 'text-left' }}">{{ __('Year') }} <span class="text-[#FF7878]">*</span></label>
                                            <select 
                                                id="og-expyear" 
                                                name="exp_year"
                                                data-og="expirationyear"
                                                x-model="expYear"
                                                class="w-full bg-[#F2F4F7] border border-[#E9E9E9] rounded-lg px-3 py-3 text-[#383E53] focus:ring-2 focus:ring-[#4AD993] focus:border-transparent transition-all"
                                            >
                                                <option value="">YY</option>
                                                @for($i = date('Y'); $i <= date('Y') + 15; $i++)
                                                    <option value="{{ $i }}">{{ substr($i, -2) }}</option>
                                                @endfor
                                            </select>
                                        </div>
                                        
                                        @if(in_array($settings['cvv_mode'], ['required', 'yes']))
                                        <div>
                                            <label class="block text-sm font-medium text-[#383E53] mb-2 {{ $rtl ? 'text-right' : 'text-left' }}">
                                                CVV @if($settings['cvv_mode'] === 'required')<span class="text-[#FF7878]">*</span>@endif
                                            </label>
                                            <input 
                                                type="text" 
                                                id="og-cvv" 
                                                name="cvv"
                                                data-og="cvv"
                                                x-model="cvv"
                                                dir="ltr"
                                                maxlength="4"
                                                inputmode="numeric"
                                                placeholder="•••"
                                                class="w-full bg-[#F2F4F7] border border-[#E9E9E9] rounded-lg px-3 py-3 text-[#383E53] text-center placeholder-[#8890B1] focus:ring-2 focus:ring-[#4AD993] focus:border-transparent transition-all"
                                            >
                                        </div>
                                        @endif
                                    </div>
                                    <p class="text-[#8890B1] text-xs {{ $rtl ? 'text-right' : 'text-left' }}">{{ __('3-4 digits on back of card') }}</p>
                                    
                                    {{-- ID Number --}}
                                    @if(in_array($settings['citizen_id_mode'], ['required', 'yes']))
                                    <div>
                                        <label class="block text-sm font-medium text-[#383E53] mb-2 {{ $rtl ? 'text-right' : 'text-left' }}">
                                            {{ __('ID Number') }} @if($settings['citizen_id_mode'] === 'required')<span class="text-[#FF7878]">*</span>@endif
                                        </label>
                                        <input 
                                            type="text" 
                                            id="og-citizenid" 
                                            name="citizen_id"
                                            data-og="citizenid"
                                            x-model="citizenId"
                                            dir="ltr"
                                            maxlength="9"
                                            inputmode="numeric"
                                            placeholder="000000000"
                                            @if(!empty($customerCitizenId))
                                                value="{{ $customerCitizenId }}"
                                                readonly
                                                class="w-full bg-gray-100 border border-gray-200 rounded-lg px-4 py-3 text-gray-600 cursor-not-allowed"
                                            @else
                                                class="w-full bg-[#F2F4F7] border border-[#E9E9E9] rounded-lg px-4 py-3 text-[#383E53] text-left placeholder-[#8890B1] focus:ring-2 focus:ring-[#4AD993] focus:border-transparent transition-all"
                                            @endif
                                        >
                                    </div>
                                    @endif
                                    
                                    @if($settings['pci_mode'] === 'no')
                                    <input type="hidden" name="og-token" data-og="token" x-model="singleUseToken">
                                    @endif
                                    
                                    {{-- Save Card --}}
                                    @if($supportTokens && auth()->check())
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" id="save_card" name="save_card" x-model="saveCard" class="w-4 h-4 text-[#4AD993] border-gray-300 rounded focus:ring-[#4AD993]">
                                        <label for="save_card" class="text-sm text-[#383E53]">{{ __('Save card for future purchases') }}</label>
                                    </div>
                                    @endif
                                </div>
                            </div>
                            
                            {{-- Bit Payment --}}
                            @if($bitEnabled)
                            <div x-show="paymentMethod === 'bit'" x-cloak class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-gray-700">{{ __('You will be redirected to complete your payment via Bit.') }}</p>
                            </div>
                            @endif
                            
                            {{-- Installments --}}
                            @if($maxPayments > 1)
                            <div x-show="paymentMethod === 'card'" class="mt-4">
                                <label class="block text-sm font-medium text-[#383E53] mb-2 {{ $rtl ? 'text-right' : 'text-left' }}">{{ __('Number of Payments') }}</label>
                                <select name="payments_count" x-model="paymentsCount" class="w-full bg-[#F2F4F7] border border-[#E9E9E9] rounded-lg px-4 py-3 text-[#383E53] focus:ring-2 focus:ring-[#4AD993] focus:border-transparent transition-all">
                                    @for($i = 1; $i <= $maxPayments; $i++)
                                        <option value="{{ $i }}">{{ $i }} {{ $i === 1 ? __('payment') : __('payments') }}</option>
                                    @endfor
                                </select>
                            </div>
                            @endif
                            
                            {{-- Terms Checkbox --}}
                            <div class="flex items-start gap-3 pt-2">
                                <input type="checkbox" id="payment-terms" class="mt-1 w-4 h-4 text-[#4AD993] border-gray-300 rounded focus:ring-[#4AD993]" required>
                                <label for="payment-terms" class="text-sm text-[#383E53] {{ $rtl ? 'text-right' : 'text-left' }}">
                                    {{ __('I agree to the') }} <a href="#" class="text-[#3B82F6] hover:underline">{{ __('Terms & Conditions') }}</a> {{ __('and') }} <a href="#" class="text-[#3B82F6] hover:underline">{{ __('Privacy Policy') }}</a>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    {{-- Trust Section + CTA --}}
                    <div class="bg-white rounded-2xl shadow-sm p-6 mt-6">
                        {{-- Trust Icons --}}
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-[#F8F9FF] rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-8 h-8 text-[#4BD0CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            </div>
                            <div class="space-y-1 text-sm text-[#8890B1]">
                                <p class="flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4 text-[#4AD993]" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                    {{ __('Bank-level encryption') }}
                                </p>
                                <p class="flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4 text-[#4AD993]" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                    {{ __('Card details never stored') }}
                                </p>
                                <p class="flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4 text-[#4AD993]" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                                    {{ __('Instant eSIM delivery') }}
                                </p>
                            </div>
                        </div>
                        
                        {{-- FIXED: Green CTA Button (v1.15.0: disabled when user exists) --}}
                        <button
                            type="submit"
                            :disabled="processing || userExists"
                            class="w-full bg-[#4AD993] hover:bg-[#3BC983] text-white font-semibold py-4 px-6 rounded-xl transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            style="box-shadow: 0 4px 14px rgba(74, 217, 147, 0.25);"
                        >
                            <template x-if="!processing">
                                <span class="flex items-center gap-2">
                                    {{ __('Pay') }} {{ $currencySymbol }}{{ number_format($amount, 2) }}
                                    <svg class="w-5 h-5 {{ $rtl ? 'rotate-180' : '' }}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                    </svg>
                                </span>
                            </template>
                            <template x-if="processing">
                                <span class="flex items-center gap-2">
                                    <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    {{ __('Processing...') }}
                                </span>
                            </template>
                        </button>
                        
                        {{-- Security Badge --}}
                        <div class="flex items-center justify-center gap-2 mt-4 text-sm text-[#8890B1]">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                            <span>{{ __('Secured by SUMIT') }}</span>
                        </div>
                    </div>
                </div>

                {{-- ========================================= --}}
                {{-- Customer Details Card (Center) --}}
                {{-- ========================================= --}}
                <div class="xl:col-span-1 {{ $rtl ? 'xl:order-3' : 'xl:order-1' }}">
                    <form id="og-checkout-form" method="POST" action="{{ $checkoutUrl }}" @submit.prevent="submitForm">
                        @csrf
                        <input type="hidden" name="payable_id" value="{{ $payable->getPayableId() }}">
                        <input type="hidden" name="payable_type" value="{{ get_class($payable) }}">
                        
                        {{-- Error Messages --}}
                        <div x-show="errors.length > 0" x-cloak class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start">
                                <svg class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                                <div class="{{ $rtl ? 'mr-3' : 'ml-3' }}">
                                    <h3 class="text-sm font-medium text-red-800">{{ __('Please fix the following errors:') }}</h3>
                                    <ul class="mt-2 text-sm text-red-700 list-disc {{ $rtl ? 'pr-5' : 'pl-5' }}">
                                        <template x-for="error in errors" :key="error">
                                            <li x-text="error"></li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                            {{-- Card Header --}}
                            <div class="bg-gradient-to-{{ $rtl ? 'l' : 'r' }} from-[#F8F9FF] to-white p-4 border-b border-gray-100">
                                <div class="flex items-center gap-3 {{ $rtl ? 'justify-end' : 'justify-start' }}">
                                    <h2 class="text-lg font-semibold text-[#111928]">{{ __('Customer & Billing') }}</h2>
                                    <div class="w-8 h-8 bg-[#4BD0CC] rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            {{-- Form Fields --}}
                            <div class="p-6 space-y-4">
                                @include('officeguy::pages.partials.input', ['id' => 'customer_name', 'label' => __('Full Name'), 'required' => true, 'value' => $customerName, 'type' => 'text', 'model' => 'customerName'])

                                {{-- Email field with existence check (v1.15.0+) --}}
                                <div>
                                    {{-- Custom email input with @blur event --}}
                                    <div class="w-full">
                                        <label for="customer_email" class="block text-sm font-medium text-[#383E53] mb-2 {{ $rtl ? 'text-right' : 'text-left' }}">
                                            {{ __('Email') }} <span class="text-[#FF7878]">*</span>
                                        </label>
                                        <input
                                            type="email"
                                            id="customer_email"
                                            name="customer_email"
                                            x-model="customerEmail"
                                            @blur="checkEmailExists()"
                                            value="{{ old('customer_email', $customerEmail ?? '') }}"
                                            dir="ltr"
                                            class="w-full bg-[#F2F4F7] border border-[#E9E9E9] rounded-lg px-4 py-3 text-[#383E53] text-left placeholder-[#8890B1] focus:ring-2 focus:ring-[#4AD993] focus:border-transparent transition-all"
                                            required
                                        >
                                    </div>

                                    {{-- Loading indicator --}}
                                    <div x-show="emailCheckLoading" x-cloak class="mt-2 text-sm text-[#8890B1] {{ $rtl ? 'text-right' : 'text-left' }} flex items-center gap-2">
                                        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>{{ __('Checking email...') }}</span>
                                    </div>

                                    {{-- Error message (fail-safe) --}}
                                    <div x-show="emailCheckError" x-cloak class="mt-2 bg-yellow-50 border-{{ $rtl ? 'r' : 'l' }}-4 border-yellow-400 p-3 rounded-lg">
                                        <p class="text-sm text-yellow-700 {{ $rtl ? 'text-right' : 'text-left' }}" x-text="emailCheckError"></p>
                                    </div>

                                    {{-- User exists warning --}}
                                    <div x-show="userExists" x-cloak class="mt-3 bg-gradient-to-{{ $rtl ? 'r' : 'l' }} from-blue-50 to-blue-100 border-{{ $rtl ? 'r' : 'l' }}-4 border-blue-500 p-4 rounded-lg shadow-sm">
                                        <div class="flex items-start {{ $rtl ? 'flex-row-reverse' : '' }}">
                                            <svg class="w-6 h-6 text-blue-600 mt-0.5 {{ $rtl ? 'mr-3' : 'ml-3' }} flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                            </svg>
                                            <div class="flex-1">
                                                <p class="text-sm font-semibold text-blue-900 {{ $rtl ? 'text-right' : 'text-left' }} mb-1">
                                                    {{ __('User with this email already exists in the system') }}
                                                </p>
                                                <p class="text-sm text-blue-700 {{ $rtl ? 'text-right' : 'text-left' }} mb-3">
                                                    {{ __('To continue with the payment process, you must first log into the system') }}
                                                </p>
                                                <a
                                                    :href="loginUrl"
                                                    class="inline-flex items-center gap-2 px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-all shadow-md hover:shadow-lg {{ $rtl ? 'flex-row-reverse' : '' }}"
                                                >
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                                                    </svg>
                                                    <span>{{ __('Login Now') }}</span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                @include('officeguy::pages.partials.input', ['id' => 'customer_phone', 'label' => __('Phone'), 'required' => true, 'value' => $customerPhone, 'type' => 'tel', 'model' => 'customerPhone'])
                                @include('officeguy::pages.partials.input', ['id' => 'customer_company', 'label' => __('Company'), 'required' => false, 'value' => $customerCompany ?? '', 'type' => 'text'])
                                @include('officeguy::pages.partials.input', ['id' => 'customer_address', 'label' => __('Street'), 'required' => true, 'value' => $customerAddress ?? '', 'type' => 'text'])
                                @include('officeguy::pages.partials.input', ['id' => 'customer_city', 'label' => __('City'), 'required' => true, 'value' => $customerCity ?? '', 'type' => 'text'])
                                @include('officeguy::pages.partials.input', ['id' => 'customer_postal', 'label' => __('Postal Code'), 'required' => false, 'value' => $customerPostal ?? '', 'type' => 'text'])
                                @include('officeguy::pages.partials.input', ['id' => 'customer_country', 'label' => __('Country'), 'required' => true, 'value' => $customerCountry ?? 'IL', 'type' => 'text'])
                            </div>
                        </div>
                    </form>
                </div>
                
                {{-- ========================================= --}}
                {{-- Order Summary Sidebar --}}
                {{-- ========================================= --}}
                <div class="xl:col-span-1 {{ $rtl ? 'xl:order-1' : 'xl:order-2' }}">
                    <div class="bg-white rounded-2xl shadow-sm p-6 sticky top-8">
                        <h2 class="text-lg font-semibold text-[#111928] mb-4">{{ __('Order Summary') }}</h2>
                        
                        {{-- Items --}}
                        <div class="space-y-3 mb-4">
                            @foreach($items as $item)
                            <div class="flex justify-between text-sm">
                                <span class="text-[#8890B1]">
                                    {{ $item['name'] }}
                                    @if(($item['quantity'] ?? 1) > 1)
                                        <span class="text-gray-400">× {{ $item['quantity'] }}</span>
                                    @endif
                                </span>
                                <span class="font-medium text-[#383E53]">{{ $currencySymbol }}{{ number_format(($item['unit_price'] ?? 0) * ($item['quantity'] ?? 1), 2) }}</span>
                            </div>
                            @endforeach
                        </div>
                        
                        @if($shipping > 0)
                        <div class="flex justify-between text-sm py-2 border-t border-gray-100">
                            <span class="text-[#8890B1]">{{ __('Shipping') }}</span>
                            <span class="font-medium text-[#383E53]">{{ $currencySymbol }}{{ number_format($shipping, 2) }}</span>
                        </div>
                        @endif
                        
                        @foreach($fees as $fee)
                        <div class="flex justify-between text-sm py-2 border-t border-gray-100">
                            <span class="text-[#8890B1]">{{ $fee['name'] }}</span>
                            <span class="font-medium text-[#383E53]">{{ $currencySymbol }}{{ number_format($fee['amount'], 2) }}</span>
                        </div>
                        @endforeach
                        
                        @if($payable->isTaxEnabled() && $payable->getVatRate())
                        <div class="flex justify-between text-sm py-2 border-t border-gray-100">
                            <span class="text-[#8890B1]">{{ __('VAT') }} ({{ $payable->getVatRate() }}%)</span>
                            <span class="font-medium text-[#383E53]">{{ __('Included') }}</span>
                        </div>
                        @endif
                        
                        {{-- Total --}}
                        <div class="flex justify-between pt-4 border-t-2 border-gray-200 mt-4">
                            <span class="text-lg font-semibold text-[#111928]">{{ __('Total') }}</span>
                            <span class="text-lg font-bold text-[#4AD993]">{{ $currencySymbol }}{{ number_format($amount, 2) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function checkoutPage() {
            return {
                rtl: @json($rtl),
                paymentMethod: 'card',
                selectedToken: @json($savedTokens->isEmpty() ? 'new' : ''),
                cardNumber: '',
                expMonth: '',
                expYear: '',
                cvv: '',
                citizenId: @json(old('citizen_id', $customerCitizenId ?? '')),
                singleUseToken: '',
                paymentsCount: '1',
                saveCard: false,
                customerName: @json(old('customer_name', $customerName ?? '')),
                customerEmail: @json(old('customer_email', $customerEmail ?? '')),
                customerPhone: @json(old('customer_phone', $customerPhone ?? '')),
                processing: false,
                errors: [],
                // Email existence check (v1.15.0+)
                userExists: false,
                emailCheckLoading: false,
                emailCheckError: null,
                loginUrl: null,
                isAuthenticated: @json(auth()->check()),
                
                init() {
                    @if($settings['pci_mode'] === 'no' && !empty($settings['company_id']) && !empty($settings['public_key']))
                    if (window.jQuery && window.OfficeGuy?.Payments) {
                        OfficeGuy.Payments.BindFormSubmit({
                            CompanyID: @json($settings['company_id']),
                            APIPublicKey: @json($settings['public_key'])
                        });
                    }
                    @endif
                },
                
                validate() {
                    this.errors = [];
                    if (!this.customerName.trim()) this.errors.push('{{ __("Full name is required") }}');
                    if (!this.customerEmail.trim()) this.errors.push('{{ __("Email is required") }}');
                    else if (!this.isValidEmail(this.customerEmail)) this.errors.push('{{ __("Please enter a valid email") }}');

                    // Block checkout if user exists and must login (v1.15.0+)
                    if (this.userExists) {
                        this.errors.push('{{ __("You must login to continue. Please use the login button below.") }}');
                    }

                    if (this.paymentMethod === 'card' && this.selectedToken === 'new') {
                        if (!this.cardNumber.trim()) this.errors.push('{{ __("Card number is required") }}');
                        if (!this.expMonth || !this.expYear) this.errors.push('{{ __("Expiration date is required") }}');
                    }
                    return this.errors.length === 0;
                },

                isValidEmail(email) {
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
                },

                /**
                 * Check if user exists by email (v1.15.0+)
                 * Called on email field blur event
                 */
                async checkEmailExists() {
                    // Reset states
                    this.userExists = false;
                    this.emailCheckLoading = false;
                    this.emailCheckError = null;
                    this.loginUrl = null;

                    // Don't check if email is empty or invalid
                    if (!this.customerEmail || !this.isValidEmail(this.customerEmail)) {
                        return;
                    }

                    // Don't check if user is already authenticated
                    if (this.isAuthenticated) {
                        return;
                    }

                    this.emailCheckLoading = true;

                    try {
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';

                        if (!csrfToken) {
                            console.error('CSRF token not found');
                            throw new Error('CSRF token missing');
                        }

                        const response = await Promise.race([
                            fetch('{{ route("officeguy.api.check-email") }}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-TOKEN': csrfToken,
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Accept': 'application/json',
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify({ email: this.customerEmail })
                            }),
                            new Promise((_, reject) =>
                                setTimeout(() => reject(new Error('Timeout')), 15000)
                            )
                        ]);

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error('API Error:', response.status, errorData);
                            throw new Error(`HTTP ${response.status}: ${errorData.message || 'Network error'}`);
                        }

                        const data = await response.json();

                        if (data.exists) {
                            this.userExists = true;
                            this.loginUrl = data.login_url || '{{ route("filament.client.auth.login") }}';
                        }
                    } catch (error) {
                        console.error('Email check error:', error);
                        // Fail-safe: continue checkout on error
                        this.emailCheckError = '{{ __("Could not verify email. You may continue checkout.") }}';
                    } finally {
                        this.emailCheckLoading = false;
                    }
                },
                
                async submitForm() {
                    // Block submission if user exists and must login (v1.15.0+)
                    if (this.userExists) {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        return;
                    }

                    if (!this.validate()) {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        return;
                    }
                    this.processing = true;
                    @if($settings['pci_mode'] === 'no')
                    await new Promise(resolve => setTimeout(resolve, 200));
                    @endif
                    document.getElementById('og-checkout-form').submit();
                }
            }
        }
    </script>

    {{-- Alpine.js - Load immediately (no defer) for language selector reactivity --}}
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    {{-- Alpine.js initialization fix - ensures components are initialized even if Alpine loads late --}}
    <script>
        (function() {
            console.log('🔧 Alpine.js initialization fix loaded');

            // Wait for Alpine to be available
            function waitForAlpine(callback, maxAttempts = 50) {
                let attempts = 0;
                const check = setInterval(() => {
                    attempts++;
                    if (typeof Alpine !== 'undefined') {
                        clearInterval(check);
                        console.log('✅ Alpine.js detected after', attempts, 'attempts');
                        callback();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(check);
                        console.error('❌ Alpine.js not found after', maxAttempts, 'attempts');
                        activateVanillaFallback();
                    }
                }, 100);
            }

            // Force Alpine to reinitialize all components
            function reinitializeAlpine() {
                console.log('🔄 Forcing Alpine.js to reinitialize components...');
                try {
                    const xDataElements = document.querySelectorAll('[x-data]');
                    console.log(`Found ${xDataElements.length} elements with x-data`);

                    xDataElements.forEach((el, index) => {
                        if (!el.__x && Alpine && Alpine.initTree) {
                            console.log(`Initializing element ${index + 1}:`, el.tagName);
                            Alpine.initTree(el);
                        }
                    });
                    console.log('✅ Alpine.js reinitialization complete');
                } catch (error) {
                    console.error('❌ Error reinitializing Alpine:', error);
                }
            }

            // Vanilla JavaScript fallback
            function activateVanillaFallback() {
                console.log('🔄 Activating vanilla JavaScript fallback...');
                const buttons = document.querySelectorAll('[data-locale-switch]');

                buttons.forEach((button) => {
                    const locale = button.getAttribute('data-locale-switch');
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('🌍 Fallback: Switching to locale:', locale);

                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '{{ route('locale.change') }}';

                        const csrfToken = document.querySelector('meta[name="csrf-token"]');
                        if (csrfToken) {
                            const csrfInput = document.createElement('input');
                            csrfInput.type = 'hidden';
                            csrfInput.name = '_token';
                            csrfInput.value = csrfToken.content;
                            form.appendChild(csrfInput);
                        }

                        const localeInput = document.createElement('input');
                        localeInput.type = 'hidden';
                        localeInput.name = 'locale';
                        localeInput.value = locale;
                        form.appendChild(localeInput);

                        document.body.appendChild(form);
                        form.submit();
                    });
                });
                console.log('✅ Vanilla fallback activated');
            }

            // Start initialization
            waitForAlpine(reinitializeAlpine);

            // Try immediate init if Alpine already loaded
            if (typeof Alpine !== 'undefined') {
                setTimeout(reinitializeAlpine, 100);
            }
        })();
    </script>

    @stack('scripts')
</body>
</html>
