# ××¡××š ××™×¤×™×•×Ÿ: ×™×¦×™×¨×ª ××©×ª××© ××•×˜×•××˜×™ ×¢× ×¡×™×¡××” ×–×× ×™×ª ×œ××—×¨ ×ª×©×œ×•× ××•×¦×œ×—

> **×ª××¨×™×š**: 2025-12-07
> **×’×¨×¡×”**: 1.0
> **×¡×˜×˜×•×¡**: ×××ª×™×Ÿ ×œ××™×©×•×¨
> **××˜×¨×”**: ×™×¦×™×¨×ª ××©×ª××© ××•×˜×•××˜×™×ª ×‘××¢×¨×›×ª ×•×©×œ×™×—×ª ××™×™×œ ×¢× ×¡×™×¡××” ×–×× ×™×ª ×œ××©×ª××©×™× ××•×¨×—×™× ×œ××—×¨ ×ª×©×œ×•× ××•×¦×œ×—

---

## ğŸ“‹ ×ª×•×›×Ÿ ×¢× ×™×™× ×™×

1. [×¨×§×¢ ×•××˜×¨×”](#×¨×§×¢-×•××˜×¨×”)
2. [× ×™×ª×•×— ×”××¢×¨×›×ª ×”×§×™×™××ª](#× ×™×ª×•×—-×”××¢×¨×›×ª-×”×§×™×™××ª)
3. [×“×¨×™×©×•×ª ×¤×•× ×§×¦×™×•× ×œ×™×•×ª](#×“×¨×™×©×•×ª-×¤×•× ×§×¦×™×•× ×œ×™×•×ª)
4. [×–×¨×™××ª ×”×ª×”×œ×™×š ×”××•×¦×¢×ª](#×–×¨×™××ª-×”×ª×”×œ×™×š-×”××•×¦×¢×ª)
5. [×¨×›×™×‘×™× ×˜×›× ×™×™×](#×¨×›×™×‘×™×-×˜×›× ×™×™×)
6. [×§×‘×¦×™× ×©×™×© ×œ×©× ×•×ª](#×§×‘×¦×™×-×©×™×©-×œ×©× ×•×ª)
7. [×§×‘×¦×™× ×—×“×©×™× ×œ×™×¦×™×¨×”](#×§×‘×¦×™×-×—×“×©×™×-×œ×™×¦×™×¨×”)
8. [×©×™× ×•×™×™× ×‘××¡×“ ×”× ×ª×•× ×™×](#×©×™× ×•×™×™×-×‘××¡×“-×”× ×ª×•× ×™×)
9. [×‘×“×™×§×•×ª × ×“×¨×©×•×ª](#×‘×“×™×§×•×ª-× ×“×¨×©×•×ª)
10. [×¡×™×›×•× ×™× ×•××ª×’×¨×™×](#×¡×™×›×•× ×™×-×•××ª×’×¨×™×)
11. [×ª×™×¢×•×“ × ×“×¨×©](#×ª×™×¢×•×“-× ×“×¨×©)

---

## ğŸ¯ ×¨×§×¢ ×•××˜×¨×”

### ×”×‘×¢×™×” ×”× ×•×›×—×™×ª

×›×™×•×, ×‘×¢××•×“ ×”×ª×©×œ×•× ×”×¦×™×‘×•×¨×™ (`PublicCheckoutController`), ××©×ª××©×™× ××•×¨×—×™× ×™×›×•×œ×™× ×œ×‘×—×•×¨:
1. **×œ×”×™×¨×©× ×•×œ×”×ª×—×‘×¨** - ×¢× ×¡×™×¡××” ×©×”× ××’×“×™×¨×™×
2. **×œ×©×œ× ×›××•×¨×—** - ×‘×œ×™ ×™×¦×™×¨×ª ×—×©×‘×•×Ÿ

×× ××©×ª××© ××•×¨×— ×‘×•×—×¨ **×œ× ×œ×™×¦×•×¨ ×—×©×‘×•×Ÿ**, ×”×•× ××©×œ× ×‘×”×¦×œ×—×” ××š:
- âŒ ×œ× × ×•×¦×¨ ×¢×‘×•×¨×• ×—×©×‘×•×Ÿ ×‘××¢×¨×›×ª
- âŒ ×”×•× ×œ× ×™×›×•×œ ×œ×¢×§×•×‘ ××—×¨ ×”×”×–×× ×”
- âŒ ×”×•× ×œ× ×™×›×•×œ ×œ×’×©×ª ×œ×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª
- âŒ ××™×Ÿ ×œ×• ×’×™×©×” ×œ×—×©×‘×•× ×™×•×ª ×•××¡××›×™×

### ×”××˜×¨×”

×œ×™×¦×•×¨ ×ª×”×œ×™×š ××•×˜×•××˜×™ ×©×‘×•:
âœ… **×œ××—×¨ ×ª×©×œ×•× ××•×¦×œ×—** ×©×œ ××©×ª××© ××•×¨×— (×œ× ××—×•×‘×¨)
âœ… ×”××¢×¨×›×ª ×ª×™×¦×•×¨ ×¢×‘×•×¨×• ×—×©×‘×•×Ÿ ××©×ª××© ××•×˜×•××˜×™×ª
âœ… ×ª×™×•×•×¦×¨ ×¡×™×¡××” ×–×× ×™×ª (12 ×ª×•×•×™× ×¨× ×“×•××œ×™×™×)
âœ… ×™×™×©×œ×— ××™×™×œ ×œ××©×ª××© ×¢× ×”×¡×™×¡××” ×”×–×× ×™×ª ×•×œ×™× ×§ ×œ×”×ª×—×‘×¨×•×ª
âœ… ×”××©×ª××© ×™×•×›×œ ×œ×”×ª×—×‘×¨ ×•×œ×’×©×ª ×œ×”×–×× ×” ×•×œ×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª

---

## ğŸ” × ×™×ª×•×— ×”××¢×¨×›×ª ×”×§×™×™××ª

### 1. ×–×¨×™××ª ×”×ª×©×œ×•× ×”× ×•×›×—×™×ª

**×§×•×‘×¥**: `src/Http/Controllers/PublicCheckoutController.php`

```php
public function process(Request $request, string|int $id)
{
    // 1. ×‘×“×™×§×ª ×”×¤×¢×œ×ª ×”×ª×›×•× ×”
    if (!$this->isEnabled()) {
        abort(404, __('Public checkout is not enabled'));
    }

    // 2. ×§×‘×œ×ª ×”-Payable (Order/Invoice)
    $payable = $this->resolvePayable($request, $id);

    // 3. ×‘×“×™×§×” ×× ××©×ª××© ××—×•×‘×¨
    $user = auth()->user();
    $client = $user?->client;

    // 4. Validation ×©×œ ×©×“×•×ª ×”×ª×©×œ×•×
    $validated = $request->validate($rules);

    // 5. ×˜×™×¤×•×œ ×‘×¨×™×©×•× ××©×ª××© ×—×“×© (×× ×‘×—×¨ ×œ×”×™×¨×©×)
    if (!$user && !empty($validated['password'])) {
        // ×™×¦×™×¨×ª ××©×ª××© ×—×“×©
        $user = \App\Models\User::create([...]);

        // Fire Registered event
        event(new \Illuminate\Auth\Events\Registered($user));

        // Send welcome notification
        $user->notify(new \App\Notifications\WelcomeNotification);

        // ×”×ª×—×‘×¨×•×ª ××•×˜×•××˜×™×ª
        \Illuminate\Support\Facades\Auth::login($user);
    }

    // 6. ×¢×™×‘×•×“ ×”×ª×©×œ×•×
    $paymentsCount = max(1, (int) ($validated['payments_count'] ?? 1));
    $paymentMethod = $validated['payment_method'];

    if ($paymentMethod === 'bit') {
        return $this->processBitPayment($payable, $validated, $request);
    }

    return $this->processCardPayment($payable, $validated, $paymentsCount, $request);
}
```

**× ×§×•×“×•×ª ×—×©×•×‘×•×ª**:
- âœ… ×›×‘×¨ ×§×™×™× ×œ×•×’×™×§×” ×œ×™×¦×™×¨×ª ××©×ª××© ×—×“×© (×©×•×¨×•×ª 192-244)
- âœ… ×›×‘×¨ × ×©×œ×— `WelcomeNotification` ×œ××©×ª××©×™× ×—×“×©×™× ×©× ×¨×©××•
- âŒ **××™×Ÿ ×™×¦×™×¨×ª ××©×ª××© ××•×˜×•××˜×™×ª ×œ××—×¨ ×ª×©×œ×•× ××•×¦×œ×— ×©×œ ××•×¨×—**

### 2. ××™×¨×•×¢ ×ª×©×œ×•× ××•×¦×œ×—

**×§×•×‘×¥**: `src/Services/PaymentService.php` (×©×•×¨×” 820)

```php
event(new \OfficeGuy\LaravelSumitGateway\Events\PaymentCompleted(
    $order->getPayableId(),
    $payment,
    $response
));
```

**Event Class**: `src/Events/PaymentCompleted.php`

```php
class PaymentCompleted
{
    public function __construct(
        public string|int $orderId,
        public array $payment,
        public array $response
    ) {}
}
```

**××” ×§×•×¨×” ×›×¨×’×¢**:
- âœ… Event × ×•×¨×” ×œ××—×¨ ×ª×©×œ×•× ××•×¦×œ×—
- âŒ ××™×Ÿ Listener ×©××˜×¤×œ ×‘×™×¦×™×¨×ª ××©×ª××© ××•×˜×•××˜×™×ª
- âœ… ×”-Event ×›×•×œ×œ ××ª ×”-`orderId`, `$payment`, `$response`

### 3. ××•×“×œ×™× ×§×™×™××™×

#### User Model
**×§×•×‘×¥**: `app/Models/User.php`

**×©×“×•×ª ×¨×œ×•×•× ×˜×™×™×**:
```php
'name' => string
'email' => string (unique)
'phone' => string|null
'first_name' => string|null
'last_name' => string|null
'password' => string (hashed)
'role' => UserRole (enum: CLIENT, ADMIN, STAFF, etc.)
'email_verified_at' => timestamp
'has_temporary_password' => boolean
'temporary_password_expires_at' => timestamp
'temporary_password_created_by' => int (user_id)
```

**Relationship**:
```php
public function client(): HasOne
{
    return $this->hasOne(Client::class);
}
```

#### Client Model
**×§×•×‘×¥**: `app/Models/Client.php`

**Method ×§×™×™×**:
```php
public static function createFromUser(User $user): self
{
    return self::create([
        'user_id' => $user->id,
        'name' => $user->name,
        'email' => $user->email,
        'description' => 'Client created from user registration',
        'is_active' => true,
        'client_name' => $user->first_name && $user->last_name
            ? "{$user->first_name} {$user->last_name}"
            : $user->name,
        'client_email' => $user->email,
        'client_phone' => $user->phone,
        'card_owner_id' => $user->id_number,
        'first_name' => $user->first_name,
        'last_name' => $user->last_name,
        'phone' => $user->phone,
        // ... more fields
    ]);
}
```

**× ×§×•×“×•×ª ×—×©×•×‘×•×ª**:
- âœ… ×›×‘×¨ ×§×™×™× method ×œ×™×¦×™×¨×ª Client ××ª×•×š User
- âœ… ×”×•× ××¢×ª×™×§ ××ª ×›×œ ×”×©×“×•×ª ×”×¨×œ×•×•× ×˜×™×™× ××•×˜×•××˜×™×ª

#### Order Model
**×§×•×‘×¥**: `app/Models/Order.php`

**Implements**: `Payable` interface

**×©×“×•×ª ×¨×œ×•×•× ×˜×™×™×**:
```php
'user_id' => int|null
'client_id' => int|null
'client_name' => string|null
'client_email' => string|null
'client_phone' => string|null
```

### 4. ××¢×¨×›×ª ×¡×™×¡×××•×ª ×–×× ×™×•×ª ×§×™×™××ª

#### CreateTemporaryPassword Action
**×§×•×‘×¥**: `app/Actions/User/Security/CreateTemporaryPassword.php`

```php
class CreateTemporaryPassword
{
    use AsAction;

    public function handle(
        User $user,
        User $createdBy,
        int $expiryHours = 24
    ): string {
        $temporaryPassword = Str::random(12);

        $user->update([
            'password' => Hash::make($temporaryPassword),
            'has_temporary_password' => true,
            'temporary_password_expires_at' => now()->addHours($expiryHours),
            'temporary_password_created_by' => $createdBy->id,
            'failed_login_attempts' => 0,
            'is_locked' => false,
        ]);

        // Send email with temporary password
        Mail::to($user)->send(new TemporaryPasswordMail(
            $user,
            $temporaryPassword,
            $createdBy,
            $expiryHours
        ));

        AddToLoginHistory::run($user, 'temporary_password_created', null, [
            'created_by' => $createdBy->name,
            'expires_at' => now()->addHours($expiryHours)->toISOString(),
        ]);

        return $temporaryPassword;
    }
}
```

**× ×§×•×“×•×ª ×—×©×•×‘×•×ª**:
- âœ… ×›×‘×¨ ×§×™×™××ª ××¢×¨×›×ª ××œ××” ×œ×¡×™×¡×××•×ª ×–×× ×™×•×ª
- âœ… ×©×œ×™×—×ª ××™×™×œ ××•×˜×•××˜×™×ª
- âœ… ××¢×§×‘ ××—×¨ ×ª×•×§×£ ×”×¡×™×¡××”
- âš ï¸ **×“×•×¨×© `$createdBy` (User)** - × ×¦×˜×¨×š ×œ×”×ª××™× ×œ××§×¨×” ×©×œ ××¢×¨×›×ª ××•×˜×•××˜×™×ª

#### TemporaryPasswordMail
**×§×•×‘×¥**: `app/Mail/TemporaryPasswordMail.php`

```php
public function __construct(
    User $user,
    string $temporaryPassword,
    ?User $staffMember = null,
    int $expiryHours = 24
)
```

**Template**: `resources/views/emails/fallback/temporary-password.blade.php`

**× ×§×•×“×•×ª ×—×©×•×‘×•×ª**:
- âœ… ×›×‘×¨ ×§×™×™× Mailable ××œ× ×¢× template ××¢×•×¦×‘
- âœ… ×ª×•××š ×‘-`$staffMember = null` (××•×¤×¦×™×•× ×œ×™)
- âœ… ×›×•×œ×œ ××ª ×”×¡×™×¡××”, ×ª×•×§×£, ×•×œ×™× ×§ ×œ×”×ª×—×‘×¨×•×ª

### 5. WelcomeNotification ×§×™×™××ª

**×§×•×‘×¥**: `app/Notifications/WelcomeNotification.php`

```php
class WelcomeNotification extends Notification implements ShouldQueue
{
    public function toMail($notifiable): MailMessage
    {
        return (new MailMessage)
            ->subject('×‘×¨×•×›×™× ×”×‘××™× ×œ×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª - NM-DigitalHUB')
            ->greeting('×©×œ×•× '.($notifiable->name ?? $notifiable->first_name).',')
            ->line('×‘×¨×•×›×™× ×”×‘××™× ×œ×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª ×©×œ NM-DigitalHUB!')
            // ... more content
            ->action('×›× ×™×¡×” ×œ×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª', $loginUrl);
    }
}
```

**× ×§×•×“×•×ª ×—×©×•×‘×•×ª**:
- âœ… × ×©×œ×—×ª ×œ××©×ª××©×™× ×©× ×¨×©××• ×‘×¢×¦××
- âš ï¸ **×œ× ××›×™×œ×” ×¡×™×¡××”** - ×× ×™×—×” ×©×”××©×ª××© ×”×’×“×™×¨ ×¡×™×¡××” ×‘×¢×¦××•

---

## ğŸ“ ×“×¨×™×©×•×ª ×¤×•× ×§×¦×™×•× ×œ×™×•×ª

### FR-1: ×–×™×”×•×™ ××©×ª××© ××•×¨×— ×‘×ª×©×œ×•× ××•×¦×œ×—

**×ª×™××•×¨**: ×”××¢×¨×›×ª ×ª×–×”×” ×× ×”×ª×©×œ×•× ×”××•×¦×œ×— ×‘×•×¦×¢ ×¢×œ ×™×“×™ ××©×ª××© ××•×¨×— (×œ× ××—×•×‘×¨).

**×§×¨×™×˜×¨×™×•× ×™×**:
- âœ… ×”×ª×©×œ×•× ×”×•×©×œ× ×‘×”×¦×œ×—×” (`PaymentCompleted` event × ×•×¨×”)
- âœ… `auth()->user()` ×”×•× `null` ×‘×–××Ÿ ×”×ª×©×œ×•×
- âœ… ×”-`Order` ××›×™×œ `client_email` ××š `user_id` ×”×•× `null`

**Input**:
- `PaymentCompleted` event
- `Order` instance

**Output**:
- `boolean` - ×”×× ×–×”×• ××©×ª××© ××•×¨×— ×©×¦×¨×™×š ×œ×™×¦×•×¨ ×¢×‘×•×¨×• ×—×©×‘×•×Ÿ

### FR-2: ×™×¦×™×¨×ª ××©×ª××© ××•×˜×•××˜×™×ª

**×ª×™××•×¨**: ×”××¢×¨×›×ª ×ª×™×¦×•×¨ ××©×ª××© ×—×“×© ×‘××¢×¨×›×ª ×¢× ×”×¤×¨×˜×™× ××”-Order.

**×§×¨×™×˜×¨×™×•× ×™×**:
- âœ… ×‘×“×™×§×” ×©×”××™××™×™×œ ×œ× ×§×™×™× ×‘××¢×¨×›×ª
- âœ… ×™×¦×™×¨×ª `User` ×¢× role `CLIENT`
- âœ… ×©×“×•×ª ×—×•×‘×”: `name`, `email`, `phone`
- âœ… ×©×“×•×ª ××•×¤×¦×™×•× ×œ×™×™×: `first_name`, `last_name`, `company`, `address`, `city`, `country`, `id_number`
- âœ… `email_verified_at` = now() (××™××•×ª ××•×˜×•××˜×™)
- âœ… `has_temporary_password` = true
- âœ… `temporary_password_expires_at` = now() + 7 days
- âœ… `temporary_password_created_by` = null (××¢×¨×›×ª ××•×˜×•××˜×™×ª)

**Input**:
```php
[
    'name' => string,
    'email' => string,
    'phone' => string|null,
    'first_name' => string|null,
    'last_name' => string|null,
    'company' => string|null,
    'address' => string|null,
    'city' => string|null,
    'country' => string|null,
    'id_number' => string|null,
]
```

**Output**:
- `User` instance

**×©×’×™××•×ª ××¤×©×¨×™×•×ª**:
- Email ×›×‘×¨ ×§×™×™× - ×“×œ×’ ×¢×œ ×™×¦×™×¨×ª ××©×ª××©, ×§×©×¨ ××ª ×”×”×–×× ×” ×œ××©×ª××© ×”×§×™×™×
- × ×ª×•× ×™× ×—×¡×¨×™× - ×”×©×ª××© ×‘×‘×¨×™×¨×•×ª ××—×“×œ

### FR-3: ×™×¦×™×¨×ª ×¡×™×¡××” ×–×× ×™×ª

**×ª×™××•×¨**: ×”××¢×¨×›×ª ×ª×™×¦×•×¨ ×¡×™×¡××” ×–×× ×™×ª ×¨× ×“×•××œ×™×ª ×•×ª×¢×“×›×Ÿ ××ª ×”××©×ª××©.

**×§×¨×™×˜×¨×™×•× ×™×**:
- âœ… ×¡×™×¡××” ×‘×ª 12 ×ª×•×•×™× (××•×ª×™×•×ª ×’×“×•×œ×•×ª, ×§×˜× ×•×ª, ××¡×¤×¨×™×)
- âœ… ×ª×•×§×£ ×©×œ 7 ×™××™×
- âœ… ×¢×“×›×•×Ÿ ×©×“×•×ª: `password`, `has_temporary_password`, `temporary_password_expires_at`

**Input**:
- `User` instance

**Output**:
- `string` - ×”×¡×™×¡××” ×”×–×× ×™×ª (plain text)

### FR-4: ×©×œ×™×—×ª ××™×™×œ ×¢× ×¡×™×¡××” ×–×× ×™×ª

**×ª×™××•×¨**: ×”××¢×¨×›×ª ×ª×©×œ×— ××™×™×œ ×œ××©×ª××© ×¢× ×”×¡×™×¡××” ×”×–×× ×™×ª ×•×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª.

**×§×¨×™×˜×¨×™×•× ×™×**:
- âœ… ×©×œ×™×—×” ×œ-Queue (×œ× ×‘×œ×•×§×™× ×’)
- âœ… ×ª×•×›×Ÿ ×”××™×™×œ ×™×›×œ×•×œ:
  - ×©× ×”××©×ª××©
  - ×”×¡×™×¡××” ×”×–×× ×™×ª (plain text)
  - ×ª××¨×™×š ×ª×¤×•×’×”
  - ×œ×™× ×§ ×œ×”×ª×—×‘×¨×•×ª
  - ×”×•×¨××•×ª ×©×™××•×©
- âœ… ×©×™××•×© ×‘-template ×§×™×™× ××• ×—×“×© (×œ×¤×™ ×”×¦×•×¨×š)

**Input**:
- `User` instance
- `string` $temporaryPassword

**Output**:
- Mail sent to queue

**×©×’×™××•×ª ××¤×©×¨×™×•×ª**:
- ×©×œ×™×—×ª ××™×™×œ × ×›×©×œ×” - log error ××š ××œ ×ª×©×‘×•×¨ ××ª ×”×ª×”×œ×™×š

### FR-5: ×™×¦×™×¨×ª Client ××”××©×ª××©

**×ª×™××•×¨**: ×”××¢×¨×›×ª ×ª×™×¦×•×¨ ×¨×©×•××ª `Client` ×¢×‘×•×¨ ×”××©×ª××© ×”×—×“×©.

**×§×¨×™×˜×¨×™×•× ×™×**:
- âœ… ×©×™××•×© ×‘-`Client::createFromUser($user)`
- âœ… ×”×¢×ª×§×ª ×›×œ ×”×¤×¨×˜×™× ×¨×œ×•×•× ×˜×™×™× ××”-User

**Input**:
- `User` instance

**Output**:
- `Client` instance

### FR-6: ×§×™×©×•×¨ ×”×”×–×× ×” ×œ××©×ª××©

**×ª×™××•×¨**: ×”××¢×¨×›×ª ×ª×¢×“×›×Ÿ ××ª ×”-`Order` ×¢× ×”-`user_id` ×•×”-`client_id` ×”×—×“×©×™×.

**×§×¨×™×˜×¨×™×•× ×™×**:
- âœ… ×¢×“×›×•×Ÿ ×©×“×•×ª: `user_id`, `client_id`
- âœ… ×©××™×¨×” ×©×œ ×”×©×“×•×ª ×”×§×™×™××™×: `client_name`, `client_email`, `client_phone`

**Input**:
- `Order` instance
- `User` instance
- `Client` instance

**Output**:
- Updated `Order` instance

### FR-7: Logging ×•××¢×§×‘

**×ª×™××•×¨**: ×”××¢×¨×›×ª ×ª×ª×¢×“ ××ª ×›×œ ×”×ª×”×œ×™×š ×œ×œ×•×’×™×.

**×§×¨×™×˜×¨×™×•× ×™×**:
- âœ… Log level: INFO
- âœ… ××™×“×¢ ×œ×›×œ×•×œ:
  - Order ID
  - Email
  - User created successfully
  - Password sent successfully
  - Any errors

**Input**:
- Event data

**Output**:
- Log entries

---

## ğŸ”„ ×–×¨×™××ª ×”×ª×”×œ×™×š ×”××•×¦×¢×ª

### Sequence Diagram

```
××©×ª××© ××•×¨×— â†’ PublicCheckoutController â†’ PaymentService â†’ SUMIT API
                                              â†“
                                         PaymentCompleted Event
                                              â†“
                                    AutoCreateUserListener â† (NEW!)
                                              â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â†“                                           â†“
              ×‘×“×™×§×”: ××©×ª××© ××•×¨×—?                          ×‘×“×™×§×”: Email ×§×™×™×?
                   YES â”‚ NO                                    YES â”‚ NO
                       â†“                                           â†“
               CreateGuestUserAction                    ×“×œ×’, ×§×©×¨ ×œ××©×ª××© ×§×™×™×
                       â†“                                           â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    ×¢×“×›×Ÿ Order.user_id
          â†“                         â†“
    User::create()        Client::createFromUser()
          â†“                         â†“
    GenerateTemporaryPassword      â†“
          â†“                         â†“
    SendTemporaryPasswordMail      â†“
          â†“                         â†“
    ×¢×“×›×Ÿ Order (user_id + client_id)
          â†“
    Log success + ×”×¡×ª×™×™×
```

### Step-by-Step Flow

#### ×©×œ×‘ 1: ×ª×©×œ×•× ××•×¦×œ×—
```
1. ××©×ª××© ××•×¨×— ×××œ× ×˜×•×¤×¡ ×ª×©×œ×•× ×‘×¢××•×“ Checkout
2. PublicCheckoutController.process() ××¢×‘×“ ××ª ×”×ª×©×œ×•×
3. PaymentService.charge() ××‘×¦×¢ ××ª ×”×—×™×•×‘ ×‘-SUMIT
4. ×ª×©×œ×•× ××•×¦×œ×— â†’ PaymentService ×¤×•×œ×˜ PaymentCompleted event
```

#### ×©×œ×‘ 2: Listener ××–×”×” ××™×¨×•×¢
```
5. AutoCreateUserListener ××§×‘×œ ××ª PaymentCompleted event
6. ××•×©×š ××ª ×”-Order ×œ×¤×™ orderId
7. ×‘×•×“×§: ×”×× user_id = null? (××©×ª××© ××•×¨×—)
   - ×× ×œ× â†’ ×¡×™×•× (××©×ª××© ×›×‘×¨ ×§×™×™×)
   - ×× ×›×Ÿ â†’ ×”××©×š
```

#### ×©×œ×‘ 3: ×‘×“×™×§×ª ×§×™×•× ××©×ª××©
```
8. ×‘×•×“×§ ×”×× ×›×‘×¨ ×§×™×™× User ×¢× client_email ×©×œ ×”×”×–×× ×”
   - ×× ×›×Ÿ â†’ ×§×©×¨ ××ª ×”×”×–×× ×” ×œ××©×ª××© ×”×§×™×™× + ×¡×™×•×
   - ×× ×œ× â†’ ×”××©×š ×œ×™×¦×™×¨×ª ××©×ª××© ×—×“×©
```

#### ×©×œ×‘ 4: ×™×¦×™×¨×ª ××©×ª××© ×—×“×©
```
9. CreateGuestUserAction::handle($order)
   - ××¤×¨×§ ××ª client_name ×œ-first_name, last_name
   - ×™×•×¦×¨ User ×—×“×© ×¢×:
     * name, email, phone
     * role = CLIENT
     * email_verified_at = now()
     * has_temporary_password = true
     * temporary_password_expires_at = now() + 7 days
```

#### ×©×œ×‘ 5: ×™×¦×™×¨×ª ×¡×™×¡××” ×–×× ×™×ª
```
10. GenerateTemporaryPassword::handle($user)
    - ×™×•×¦×¨ ×¡×™×¡××” ×¨× ×“×•××œ×™×ª (12 chars)
    - ××¢×“×›×Ÿ user.password = Hash::make($password)
    - ××—×–×™×¨ ××ª ×”×¡×™×¡××” (plain text)
```

#### ×©×œ×‘ 6: ×©×œ×™×—×ª ××™×™×œ
```
11. SendTemporaryPasswordMail::dispatch($user, $password)
    - ×™×•×¦×¨ GuestWelcomeWithPasswordMail
    - ×©×•×œ×— ×œ-Queue
    - ×”××™×™×œ ×›×•×œ×œ:
      * ×‘×¨×•×›×™× ×”×‘××™×
      * ×”×¡×™×¡××” ×”×–×× ×™×ª
      * ×œ×™× ×§ ×œ×”×ª×—×‘×¨×•×ª
      * ×¤×¨×˜×™ ×”×”×–×× ×”
```

#### ×©×œ×‘ 7: ×™×¦×™×¨×ª Client
```
12. Client::createFromUser($user)
    - ×™×•×¦×¨ Client record
    - ××¢×ª×™×§ ×©×“×•×ª ××”-User
    - ××—×–×™×¨ Client instance
```

#### ×©×œ×‘ 8: ×§×™×©×•×¨ ×”×”×–×× ×”
```
13. $order->update([
        'user_id' => $user->id,
        'client_id' => $client->id,
    ])
```

#### ×©×œ×‘ 9: Logging
```
14. Log::info('Auto-created user after successful payment', [
        'order_id' => $order->id,
        'user_id' => $user->id,
        'email' => $user->email,
    ])
```

---

## ğŸ› ï¸ ×¨×›×™×‘×™× ×˜×›× ×™×™×

### 1. Event Listener (×—×“×©)

**Class**: `AutoCreateUserListener`
**File**: `src/Listeners/AutoCreateUserListener.php`
**Purpose**: ×œ×”××–×™×Ÿ ×œ-`PaymentCompleted` event ×•×œ×™×¦×•×¨ ××©×ª××© ××•×˜×•××˜×™×ª

```php
<?php

declare(strict_types=1);

namespace OfficeGuy\LaravelSumitGateway\Listeners;

use App\Actions\User\Security\CreateTemporaryPassword;
use App\Mail\GuestWelcomeWithPasswordMail;
use App\Models\Client;
use App\Models\User;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Mail;
use OfficeGuy\LaravelSumitGateway\Events\PaymentCompleted;
use OfficeGuy\LaravelSumitGateway\Models\OfficeGuyTransaction;

class AutoCreateUserListener
{
    /**
     * Handle the event.
     */
    public function handle(PaymentCompleted $event): void
    {
        try {
            // 1. Get the Order/Payable
            $order = $this->resolveOrder($event->orderId);

            if (!$order) {
                Log::warning('AutoCreateUser: Order not found', [
                    'order_id' => $event->orderId,
                ]);
                return;
            }

            // 2. Check if guest user (user_id is null)
            if ($order->user_id !== null) {
                // User already exists, skip
                return;
            }

            // 3. Check if email is provided
            if (empty($order->client_email)) {
                Log::warning('AutoCreateUser: No email in order', [
                    'order_id' => $order->id,
                ]);
                return;
            }

            // 4. Check if user already exists with this email
            $existingUser = User::where('email', $order->client_email)->first();

            if ($existingUser) {
                // Link order to existing user
                $this->linkOrderToExistingUser($order, $existingUser);
                return;
            }

            // 5. Create new user
            $user = $this->createUserFromOrder($order);

            // 6. Generate temporary password
            $temporaryPassword = $this->generateTemporaryPassword($user);

            // 7. Send email with temporary password
            $this->sendWelcomeEmail($user, $temporaryPassword, $order);

            // 8. Create Client record
            $client = Client::createFromUser($user);

            // 9. Link order to user and client
            $order->update([
                'user_id' => $user->id,
                'client_id' => $client->id,
            ]);

            // 10. Log success
            Log::info('AutoCreateUser: User created successfully', [
                'order_id' => $order->id,
                'user_id' => $user->id,
                'client_id' => $client->id,
                'email' => $user->email,
            ]);

        } catch (\Exception $e) {
            Log::error('AutoCreateUser: Failed to create user', [
                'order_id' => $event->orderId,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);
        }
    }

    /**
     * Resolve the order from orderId.
     */
    protected function resolveOrder(string|int $orderId)
    {
        // Try to find Order by ID
        $orderClass = config('officeguy.order.model', \App\Models\Order::class);

        if (class_exists($orderClass)) {
            return $orderClass::find($orderId);
        }

        return null;
    }

    /**
     * Link order to existing user.
     */
    protected function linkOrderToExistingUser($order, User $user): void
    {
        $client = $user->client;

        if (!$client) {
            $client = Client::createFromUser($user);
        }

        $order->update([
            'user_id' => $user->id,
            'client_id' => $client->id,
        ]);

        Log::info('AutoCreateUser: Linked order to existing user', [
            'order_id' => $order->id,
            'user_id' => $user->id,
        ]);
    }

    /**
     * Create user from order data.
     */
    protected function createUserFromOrder($order): User
    {
        // Parse name into first_name and last_name
        $nameParts = explode(' ', trim($order->client_name ?? $order->billing_name ?? 'Guest User'), 2);
        $firstName = $nameParts[0] ?? '';
        $lastName = $nameParts[1] ?? '';

        return User::create([
            'name' => $order->client_name ?? $order->billing_name ?? $order->client_email,
            'first_name' => $firstName,
            'last_name' => $lastName,
            'email' => $order->client_email,
            'phone' => $order->client_phone ?? $order->billing_phone,
            'company' => $order->billing_name ?? null,
            'address' => $order->billing_address ?? null,
            'city' => $order->billing_city ?? null,
            'state' => $order->billing_state ?? null,
            'country' => $order->billing_country ?? 'IL',
            'postal_code' => $order->billing_zip ?? null,
            'id_number' => null, // Not available in order
            'password' => '', // Will be set by generateTemporaryPassword
            'role' => \App\Enums\UserRole::CLIENT,
            'email_verified_at' => now(),
            'has_temporary_password' => true,
            'temporary_password_expires_at' => now()->addDays(7),
            'temporary_password_created_by' => null, // System-generated
        ]);
    }

    /**
     * Generate temporary password for user.
     */
    protected function generateTemporaryPassword(User $user): string
    {
        $temporaryPassword = \Illuminate\Support\Str::random(12);

        $user->update([
            'password' => \Illuminate\Support\Facades\Hash::make($temporaryPassword),
        ]);

        return $temporaryPassword;
    }

    /**
     * Send welcome email with temporary password.
     */
    protected function sendWelcomeEmail(User $user, string $password, $order): void
    {
        Mail::to($user->email)->queue(
            new GuestWelcomeWithPasswordMail($user, $password, $order)
        );
    }
}
```

### 2. Mailable (×—×“×©)

**Class**: `GuestWelcomeWithPasswordMail`
**File**: `app/Mail/GuestWelcomeWithPasswordMail.php`
**Purpose**: ××™×™×œ ×‘×¨×•×›×™× ×”×‘××™× ×¢× ×¡×™×¡××” ×–×× ×™×ª ×œ××©×ª××© ×©× ×•×¦×¨ ××•×˜×•××˜×™×ª

```php
<?php

namespace App\Mail;

use App\Models\User;
use Illuminate\Bus\Queueable;
use Illuminate\Mail\Mailable;
use Illuminate\Queue\SerializesModels;

class GuestWelcomeWithPasswordMail extends Mailable
{
    use Queueable, SerializesModels;

    public User $user;
    public string $temporaryPassword;
    public $order;
    public int $expiryDays = 7;

    /**
     * Create a new message instance.
     */
    public function __construct(User $user, string $temporaryPassword, $order)
    {
        $this->user = $user;
        $this->temporaryPassword = $temporaryPassword;
        $this->order = $order;
    }

    /**
     * Build the message.
     */
    public function build()
    {
        $loginUrl = route('filament.client.auth.login');
        $orderUrl = route('filament.client.resources.orders.view', ['record' => $this->order->id]);

        return $this->to($this->user->email)
            ->subject('×ª×©×œ×•× ×‘×•×¦×¢ ×‘×”×¦×œ×—×” - ×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª ×œ×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª')
            ->view('emails.guest-welcome-with-password', [
                'user' => $this->user,
                'temporaryPassword' => $this->temporaryPassword,
                'order' => $this->order,
                'loginUrl' => $loginUrl,
                'orderUrl' => $orderUrl,
                'expiryTime' => now()->addDays($this->expiryDays)->format('d/m/Y'),
            ]);
    }
}
```

### 3. Email Template (×—×“×©)

**File**: `resources/views/emails/guest-welcome-with-password.blade.php`
**Purpose**: ×ª×‘× ×™×ª HTML ×œ××™×™×œ

```blade
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×¨×•×›×™× ×”×‘××™× - {{ config('app.name') }}</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            direction: rtl;
            text-align: right;
            background-color: #f8f9fa;
            margin: 0;
            padding: 20px;
        }
        .email-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .success-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .content {
            padding: 30px;
        }
        .success-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .password-section {
            background-color: #f8f9fa;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 25px;
            margin: 25px 0;
            text-align: center;
        }
        .password-value {
            background-color: #007bff;
            color: white;
            padding: 15px 25px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
            letter-spacing: 2px;
            display: inline-block;
            margin: 10px 0;
        }
        .action-button {
            display: inline-block;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            text-decoration: none;
            padding: 15px 40px;
            border-radius: 6px;
            font-weight: 600;
            margin: 25px 0;
        }
        .order-details {
            background-color: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }
        .footer {
            background-color: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="header">
            <div class="success-icon">âœ…</div>
            <h1>×ª×©×œ×•× ×‘×•×¦×¢ ×‘×”×¦×œ×—×”!</h1>
            <p style="margin: 0;">× ×•×¦×¨ ×¢×‘×•×¨×š ×—×©×‘×•×Ÿ ×‘×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª</p>
        </div>

        <div class="content">
            <div class="success-box">
                <h2 style="color: #155724; margin-top: 0;">×©×œ×•× {{ $user->name }},</h2>
                <p style="color: #155724; line-height: 1.6;">
                    ×ª×©×œ×•××š ×‘×•×¦×¢ ×‘×”×¦×œ×—×”! âœ¨<br>
                    × ×•×¦×¨ ×¢×‘×•×¨×š ×—×©×‘×•×Ÿ ××•×˜×•××˜×™ ×‘×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª ×©×œ {{ config('app.name') }}.<br>
                    ×¢×›×©×™×• ×ª×•×›×œ ×œ×¢×§×•×‘ ××—×¨ ×”×”×–×× ×”, ×œ×¦×¤×•×ª ×‘×—×©×‘×•× ×™×•×ª ×•×œ× ×”×œ ××ª ×”×©×™×¨×•×ª×™× ×©×œ×š.
                </p>
            </div>

            <div class="password-section">
                <h3 style="color: #495057;">×”×¡×™×¡××” ×”×–×× ×™×ª ×©×œ×š:</h3>
                <div class="password-value">{{ $temporaryPassword }}</div>
                <p style="margin: 15px 0 0 0; color: #6c757d; font-size: 14px;">
                    ×”×¢×ª×§ ××ª ×”×¡×™×¡××” ×‘×“×™×•×§ ×›×¤×™ ×©××•×¦×’×ª ×œ××¢×œ×”
                </p>
            </div>

            <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #856404; margin-top: 0;">×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª:</h3>
                <p style="color: #856404; margin: 5px 0;"><strong>××™××™×™×œ:</strong> {{ $user->email }}</p>
                <p style="color: #856404; margin: 5px 0;"><strong>×¡×™×¡××” ×–×× ×™×ª:</strong> {{ $temporaryPassword }}</p>
                <p style="color: #856404; margin: 5px 0;"><strong>×ª×•×§×£ ×¢×“:</strong> {{ $expiryTime }}</p>
            </div>

            <div style="text-align: center;">
                <a href="{{ $loginUrl }}" class="action-button">
                    ×›× ×™×¡×” ×œ×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª
                </a>
            </div>

            <div class="order-details">
                <h3 style="color: #004085; margin-top: 0;">×¤×¨×˜×™ ×”×”×–×× ×”:</h3>
                <p style="color: #004085; margin: 5px 0;"><strong>××¡×¤×¨ ×”×–×× ×”:</strong> #{{ $order->id }}</p>
                <p style="color: #004085; margin: 5px 0;"><strong>×¡×›×•×:</strong> â‚ª{{ number_format($order->total_amount, 2) }}</p>
                <p style="margin-top: 15px;">
                    <a href="{{ $orderUrl }}" style="color: #007bff; text-decoration: none;">
                        ×¦×¤×” ×‘×”×–×× ×” ×”××œ××” Â»
                    </a>
                </p>
            </div>

            <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 20px; margin-top: 25px;">
                <h3 style="color: #856404; margin-top: 0;">×”×•×¨××•×ª ×—×©×•×‘×•×ª:</h3>
                <ul style="color: #856404; line-height: 1.6;">
                    <li>×”×©×ª××© ×‘×¡×™×¡××” ×”×–×× ×™×ª ×œ×”×ª×—×‘×¨×•×ª ×”×¨××©×•× ×”</li>
                    <li>×œ××—×¨ ×”×”×ª×—×‘×¨×•×ª ×ª×ª×‘×§×© ×œ×§×‘×•×¢ ×¡×™×¡××” ×§×‘×•×¢×” ×—×“×©×”</li>
                    <li>×”×¡×™×¡××” ×”×–×× ×™×ª ×ª×¤×•×’ ×‘-{{ $expiryTime }}</li>
                    <li>××œ ×ª×©×ª×£ ××ª ×”×¡×™×¡××” ×¢× ××—×¨×™×</li>
                </ul>
            </div>
        </div>

        <div class="footer">
            <p>××™×™×œ ×–×” × ×©×œ×— ××•×˜×•××˜×™×ª ×××¢×¨×›×ª {{ config('app.name') }}.</p>
            <p>×œ×©××œ×•×ª ×•×ª××™×›×”: support@nm-digitalhub.com</p>
        </div>
    </div>
</body>
</html>
```

---

## ğŸ“‚ ×§×‘×¦×™× ×©×™×© ×œ×©× ×•×ª

### 1. OfficeGuyServiceProvider.php

**File**: `src/OfficeGuyServiceProvider.php`
**×©×™× ×•×™×™×**: ×¨×™×©×•× ×”-Listener ×”×—×“×©

**×§×•×“ ×œ×¤× ×™**:
```php
public function boot(): void
{
    // ... existing code ...

    // Register webhook event listener subscriber
    Event::subscribe(WebhookEventListener::class);

    // Register customer sync listener (v1.2.4+)
    Event::listen(
        SumitWebhookReceived::class,
        CustomerSyncListener::class
    );

    // ... rest of code ...
}
```

**×§×•×“ ××—×¨×™**:
```php
public function boot(): void
{
    // ... existing code ...

    // Register webhook event listener subscriber
    Event::subscribe(WebhookEventListener::class);

    // Register customer sync listener (v1.2.4+)
    Event::listen(
        SumitWebhookReceived::class,
        CustomerSyncListener::class
    );

    // Register auto-create user listener (v1.14.0+)
    // Automatically creates user accounts for guest payments
    Event::listen(
        \OfficeGuy\LaravelSumitGateway\Events\PaymentCompleted::class,
        \OfficeGuy\LaravelSumitGateway\Listeners\AutoCreateUserListener::class
    );

    // ... rest of code ...
}
```

**×©×•×¨×”**: ××—×¨×™ ×©×•×¨×” 122

### 2. config/officeguy.php

**File**: `config/officeguy.php`
**×©×™× ×•×™×™×**: ×”×•×¡×¤×ª ×”×’×“×¨×” ×—×“×©×” ×œ××¤×©×¨×•×ª ×›×™×‘×•×™/×”×¤×¢×œ×”

**×§×•×“ ×œ×”×•×¡×™×£**:
```php
/*
|--------------------------------------------------------------------------
| Auto-Create User for Guest Payments
|--------------------------------------------------------------------------
|
| When enabled, the system will automatically create a user account
| for guest users after a successful payment and send them a temporary
| password via email.
|
| Options:
| - true: Auto-create users (default)
| - false: Disable auto-creation
|
*/
'auto_create_guest_user' => env('OFFICEGUY_AUTO_CREATE_GUEST_USER', true),
'guest_password_expiry_days' => env('OFFICEGUY_GUEST_PASSWORD_EXPIRY_DAYS', 7),
```

**××™×§×•×**: ××—×¨×™ ×©×•×¨×” 100 (Customer Management section)

---

## ğŸ“„ ×§×‘×¦×™× ×—×“×©×™× ×œ×™×¦×™×¨×”

### 1. AutoCreateUserListener.php
- **Path**: `src/Listeners/AutoCreateUserListener.php`
- **Purpose**: Listener ×œ××™×¨×•×¢ PaymentCompleted
- **Content**: ×¨××” [×¨×›×™×‘×™× ×˜×›× ×™×™×](#1-event-listener-×—×“×©)

### 2. GuestWelcomeWithPasswordMail.php
- **Path**: `app/Mail/GuestWelcomeWithPasswordMail.php`
- **Purpose**: Mailable ×œ××™×™×œ ×‘×¨×•×›×™× ×”×‘××™×
- **Content**: ×¨××” [×¨×›×™×‘×™× ×˜×›× ×™×™×](#2-mailable-×—×“×©)

### 3. guest-welcome-with-password.blade.php
- **Path**: `resources/views/emails/guest-welcome-with-password.blade.php`
- **Purpose**: ×ª×‘× ×™×ª HTML ×œ××™×™×œ
- **Content**: ×¨××” [×¨×›×™×‘×™× ×˜×›× ×™×™×](#3-email-template-×—×“×©)

---

## ğŸ—„ï¸ ×©×™× ×•×™×™× ×‘××¡×“ ×”× ×ª×•× ×™×

**××™×Ÿ ×¦×•×¨×š ×‘×©×™× ×•×™×™× ×‘××¡×“ ×”× ×ª×•× ×™×!**

×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™× ×›×‘×¨ ×§×™×™××™×:

### ×˜×‘×œ×ª `users`
âœ… `has_temporary_password` - ×§×™×™×
âœ… `temporary_password_expires_at` - ×§×™×™×
âœ… `temporary_password_created_by` - ×§×™×™×
âœ… `email_verified_at` - ×§×™×™×
âœ… `role` - ×§×™×™×

### ×˜×‘×œ×ª `clients`
âœ… ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™× - ×§×™×™××™×

### ×˜×‘×œ×ª `orders`
âœ… `user_id` - ×§×™×™×
âœ… `client_id` - ×§×™×™×
âœ… `client_email` - ×§×™×™×
âœ… `client_name` - ×§×™×™×
âœ… `client_phone` - ×§×™×™×

---

## ğŸ§ª ×‘×“×™×§×•×ª × ×“×¨×©×•×ª

### Unit Tests

#### 1. AutoCreateUserListenerTest.php

**File**: `tests/Unit/Listeners/AutoCreateUserListenerTest.php`

```php
<?php

namespace Tests\Unit\Listeners;

use App\Models\Order;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Event;
use Illuminate\Support\Facades\Mail;
use OfficeGuy\LaravelSumitGateway\Events\PaymentCompleted;
use OfficeGuy\LaravelSumitGateway\Listeners\AutoCreateUserListener;
use Tests\TestCase;

class AutoCreateUserListenerTest extends TestCase
{
    use RefreshDatabase;

    /** @test */
    public function it_creates_user_for_guest_payment()
    {
        Mail::fake();

        $order = Order::factory()->create([
            'user_id' => null,
            'client_email' => 'guest@example.com',
            'client_name' => 'John Doe',
            'client_phone' => '0501234567',
        ]);

        $event = new PaymentCompleted(
            $order->id,
            ['amount' => 100],
            ['status' => 'Success']
        );

        $listener = new AutoCreateUserListener();
        $listener->handle($event);

        $this->assertDatabaseHas('users', [
            'email' => 'guest@example.com',
            'has_temporary_password' => true,
        ]);

        $user = User::where('email', 'guest@example.com')->first();
        $this->assertNotNull($user);
        $this->assertNotNull($user->client);

        $order->refresh();
        $this->assertEquals($user->id, $order->user_id);
        $this->assertEquals($user->client->id, $order->client_id);

        Mail::assertQueued(\App\Mail\GuestWelcomeWithPasswordMail::class);
    }

    /** @test */
    public function it_links_order_to_existing_user()
    {
        $user = User::factory()->create([
            'email' => 'existing@example.com',
        ]);

        $order = Order::factory()->create([
            'user_id' => null,
            'client_email' => 'existing@example.com',
        ]);

        $event = new PaymentCompleted(
            $order->id,
            ['amount' => 100],
            ['status' => 'Success']
        );

        $listener = new AutoCreateUserListener();
        $listener->handle($event);

        $order->refresh();
        $this->assertEquals($user->id, $order->user_id);

        // Should NOT create a new user
        $this->assertEquals(1, User::where('email', 'existing@example.com')->count());
    }

    /** @test */
    public function it_skips_if_order_already_has_user()
    {
        $user = User::factory()->create();

        $order = Order::factory()->create([
            'user_id' => $user->id,
        ]);

        $event = new PaymentCompleted(
            $order->id,
            ['amount' => 100],
            ['status' => 'Success']
        );

        $userCountBefore = User::count();

        $listener = new AutoCreateUserListener();
        $listener->handle($event);

        $this->assertEquals($userCountBefore, User::count());
    }
}
```

### Feature Tests

#### 2. GuestPaymentFlowTest.php

**File**: `tests/Feature/GuestPaymentFlowTest.php`

```php
<?php

namespace Tests\Feature;

use App\Models\Order;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Illuminate\Support\Facades\Event;
use Illuminate\Support\Facades\Mail;
use Tests\TestCase;

class GuestPaymentFlowTest extends TestCase
{
    use RefreshDatabase;

    /** @test */
    public function guest_receives_account_after_successful_payment()
    {
        Mail::fake();
        Event::fake();

        $order = Order::factory()->create([
            'user_id' => null,
            'client_email' => 'newguest@example.com',
            'client_name' => 'Jane Smith',
            'total_amount' => 200,
        ]);

        // Simulate successful payment
        event(new \OfficeGuy\LaravelSumitGateway\Events\PaymentCompleted(
            $order->id,
            ['amount' => 200],
            ['status' => 'Success', 'transactionId' => 'TXN123']
        ));

        // Assert user was created
        $this->assertDatabaseHas('users', [
            'email' => 'newguest@example.com',
        ]);

        // Assert welcome email was sent
        Mail::assertQueued(\App\Mail\GuestWelcomeWithPasswordMail::class);

        // Assert order is linked to user
        $order->refresh();
        $this->assertNotNull($order->user_id);
        $this->assertNotNull($order->client_id);
    }
}
```

### Manual Testing Checklist

âœ… **Test 1: ×ª×©×œ×•× ××•×¦×œ×— ×©×œ ××•×¨×— ×—×“×©**
1. ×’×© ×œ×¢××•×“ Checkout ×‘×œ×™ ×œ×”×ª×—×‘×¨
2. ××œ× ××ª ×”×¤×¨×˜×™× (email ×—×“×©)
3. **××œ ×ª×¡××Ÿ** "Create account"
4. ×‘×¦×¢ ×ª×©×œ×•× ××•×¦×œ×—
5. âœ… ×‘×“×•×§ ×©× ×•×¦×¨ User ×—×“×© ×‘-DB
6. âœ… ×‘×“×•×§ ×©× ×•×¦×¨ Client ×—×“×© ×‘-DB
7. âœ… ×‘×“×•×§ ×©×”×”×–×× ×” ××§×•×©×¨×ª ×œ-User ×•×œ-Client
8. âœ… ×‘×“×•×§ ×©× ×©×œ×— ××™×™×œ ×¢× ×¡×™×¡××” ×–×× ×™×ª
9. âœ… ×”×ª×—×‘×¨ ×¢× ×”××™××™×™×œ ×•×”×¡×™×¡××” ×©×”×ª×§×‘×œ×” ×‘××™×™×œ
10. âœ… ×•×•×“× ×©××ª×” ×¨×•××” ××ª ×”×”×–×× ×” ×‘×¤×•×¨×˜×œ

âœ… **Test 2: ×ª×©×œ×•× ×©×œ ××•×¨×— ×¢× email ×§×™×™×**
1. ×¦×•×¨ User ×™×“× ×™×ª ×¢× email: `test@example.com`
2. ×’×© ×œ×¢××•×“ Checkout ×‘×œ×™ ×œ×”×ª×—×‘×¨
3. ××œ× ×¤×¨×˜×™× ×¢× email: `test@example.com`
4. ×‘×¦×¢ ×ª×©×œ×•× ××•×¦×œ×—
5. âœ… ×‘×“×•×§ ×©×œ× × ×•×¦×¨ User × ×•×¡×£
6. âœ… ×‘×“×•×§ ×©×”×”×–×× ×” ××§×•×©×¨×ª ×œ-User ×”×§×™×™×
7. âœ… ×‘×“×•×§ ×©×œ× × ×©×œ×— ××™×™×œ (×›×™ ×”××©×ª××© ×›×‘×¨ ×§×™×™×)

âœ… **Test 3: ×ª×©×œ×•× ×©×œ ××©×ª××© ××—×•×‘×¨**
1. ×”×ª×—×‘×¨ ×œ××¢×¨×›×ª
2. ×’×© ×œ×¢××•×“ Checkout
3. ×‘×¦×¢ ×ª×©×œ×•×
4. âœ… ×‘×“×•×§ ×©×œ× × ×•×¦×¨ User ×—×“×©
5. âœ… ×‘×“×•×§ ×©×”×”×–×× ×” ××§×•×©×¨×ª ×œ××©×ª××© ×”××—×•×‘×¨

âœ… **Test 4: ×‘×“×™×§×ª ×ª×•×›×Ÿ ×”××™×™×œ**
1. ×‘×¦×¢ Test 1
2. âœ… ×¤×ª×— ××ª ×”××™×™×œ ×©× ×©×œ×—
3. âœ… ×•×•×“× ×©×”×¡×™×¡××” ××•×¦×’×ª ×‘×‘×™×¨×•×¨
4. âœ… ×•×•×“× ×©×™×© ×œ×™× ×§ ×œ×”×ª×—×‘×¨×•×ª
5. âœ… ×•×•×“× ×©×™×© ×¤×¨×˜×™ ×”×”×–×× ×”
6. âœ… ×•×•×“× ×©×”×¢×™×¦×•×‘ ×ª×§×™×Ÿ (RTL, Hebrew)

âœ… **Test 5: ×‘×“×™×§×ª ×ª×•×§×£ ×”×¡×™×¡××”**
1. ×‘×¦×¢ Test 1
2. âœ… ×‘×“×•×§ ×‘-DB ×©-`temporary_password_expires_at` = now() + 7 days
3. âœ… ×‘×“×•×§ ×©-`has_temporary_password` = true

---

## âš ï¸ ×¡×™×›×•× ×™× ×•××ª×’×¨×™×

### ×¡×™×›×•×Ÿ 1: ××©×ª××© ×œ× ××§×‘×œ ××™×™×œ
**×ª×¨×—×™×©**: ×©×œ×™×—×ª ×”××™×™×œ × ×›×©×œ×”
**×”×©×¤×¢×”**: ××©×ª××© ×œ× ×™×›×•×œ ×œ×”×ª×—×‘×¨
**×¤×ª×¨×•×Ÿ**:
- Log errors ×œ××¢×§×‘
- ×©×™××•×© ×‘-Queue ×¢× retry mechanism
- ×”×¦×’×ª ×”×¡×™×¡××” ×‘×¢××•×“ ×”×ª×•×“×” (××•×¤×¦×™×•× ×œ×™)

### ×¡×™×›×•×Ÿ 2: ×™×¦×™×¨×ª ××©×ª××© ×›×¤×•×œ
**×ª×¨×—×™×©**: ×©× ×™ ×ª×©×œ×•××™× ×‘××§×‘×™×œ ×××•×ª×• email
**×”×©×¤×¢×”**: ×©×’×™××ª DB (unique constraint)
**×¤×ª×¨×•×Ÿ**:
- Try-catch ×¢×œ User::create()
- ×‘×“×™×§×” × ×•×¡×¤×ª ×œ×¤× ×™ ×™×¦×™×¨×”
- ×©×™××•×© ×‘-DB transactions

### ×¡×™×›×•×Ÿ 3: ×¡×™×¡××” ×¤×’×”
**×ª×¨×—×™×©**: ××©×ª××© ×œ× ×”×ª×—×‘×¨ ×‘×ª×•×š 7 ×™××™×
**×”×©×¤×¢×”**: ×œ× ×™×›×•×œ ×œ×”×ª×—×‘×¨
**×¤×ª×¨×•×Ÿ**:
- ×©×œ×™×—×ª ××™×™×œ ×ª×–×›×•×¨×ª ×‘×™×•× 5
- ××¤×©×¨×•×ª ×œ×©×—×–×¨ ×¡×™×¡××”
- ×”××¨×›×ª ×ª×•×§×£ ×œ-14 ×™××™× (××•×¤×¦×™×•× ×œ×™)

### ×¡×™×›×•×Ÿ 4: ×”×–×× ×” ×œ×œ× email
**×ª×¨×—×™×©**: Order.client_email = null
**×”×©×¤×¢×”**: ×œ× × ×™×ª×Ÿ ×œ×™×¦×•×¨ ××©×ª××©
**×¤×ª×¨×•×Ÿ**:
- Validation ×‘-Checkout (×›×‘×¨ ×§×™×™×)
- Skip user creation if no email
- Log warning

### ×¡×™×›×•×Ÿ 5: ×‘×™×¦×•×¢×™×
**×ª×¨×—×™×©**: ×¢×•××¡ ×¢×œ ×©×¨×ª ×”××™×™×œ
**×”×©×¤×¢×”**: ××™×˜×™×•×ª ×‘××¢×¨×›×ª
**×¤×ª×¨×•×Ÿ**:
- ×©×™××•×© ×‘-Queue (×›×‘×¨ ××™×•×©×)
- Rate limiting ×¢×œ ××™×™×œ×™×
- Caching ×©×œ templates

---

## ğŸ“š ×ª×™×¢×•×“ × ×“×¨×©

### 1. ×¢×“×›×•×Ÿ README.md

**File**: `/var/www/vhosts/nm-digitalhub.com/SUMIT-Payment-Gateway-for-laravel/README.md`

**×ª×•×›×Ÿ ×œ×”×•×¡×™×£** (××—×¨×™ ×©×•×¨×” 150):

```markdown
### ×™×¦×™×¨×ª ××©×ª××© ××•×˜×•××˜×™×ª ×œ××—×¨ ×ª×©×œ×•× (v1.14.0+)

×”×—×‘×™×œ×” ×™×•×¦×¨×ª ××•×˜×•××˜×™×ª ×—×©×‘×•×Ÿ ××©×ª××© ×¢×‘×•×¨ ××©×ª××©×™× ××•×¨×—×™× ×œ××—×¨ ×ª×©×œ×•× ××•×¦×œ×—.

**××™×š ×–×” ×¢×•×‘×“:**

1. ××©×ª××© ××•×¨×— ×××œ× ×˜×•×¤×¡ ×ª×©×œ×•× (×‘×œ×™ ×œ×¡××Ÿ "Create account")
2. ×”×ª×©×œ×•× ××•×©×œ× ×‘×”×¦×œ×—×”
3. ×”××¢×¨×›×ª ×™×•×¦×¨×ª ×—×©×‘×•×Ÿ ××©×ª××© ××•×˜×•××˜×™×ª
4. × ×•×¦×¨×ª ×¡×™×¡××” ×–×× ×™×ª (12 ×ª×•×•×™×, ×ª×•×§×£ 7 ×™××™×)
5. × ×©×œ×— ××™×™×œ ×œ××©×ª××© ×¢×:
   - ×‘×¨×›×” ×•×”×•×“×¢×ª ×”×¦×œ×—×”
   - ×”×¡×™×¡××” ×”×–×× ×™×ª
   - ×œ×™× ×§ ×œ×”×ª×—×‘×¨×•×ª
   - ×¤×¨×˜×™ ×”×”×–×× ×”
6. ×”××©×ª××© ×™×›×•×œ ×œ×”×ª×—×‘×¨ ×•×œ×’×©×ª ×œ×¤×•×¨×˜×œ ×”×œ×§×•×—×•×ª

**×”×’×“×¨×•×ª:**

```php
// config/officeguy.php
'auto_create_guest_user' => true, // ×”×¤×¢×œ×”/×›×™×‘×•×™
'guest_password_expiry_days' => 7, // ×ª×•×§×£ ×¡×™×¡××” ×–×× ×™×ª
```

**××• ×‘-.env:**

```env
OFFICEGUY_AUTO_CREATE_GUEST_USER=true
OFFICEGUY_GUEST_PASSWORD_EXPIRY_DAYS=7
```

**×”×ª×××ª ×ª×‘× ×™×ª ×”××™×™×œ:**

× ×™×ª×Ÿ ×œ×¤×¨×¡× ×•×œ×¢×¨×•×š ××ª ×ª×‘× ×™×ª ×”××™×™×œ:

```bash
php artisan vendor:publish --tag=officeguy-views
```

×§×•×‘×¥ ×”×ª×‘× ×™×ª: `resources/views/emails/guest-welcome-with-password.blade.php`

**×›×™×‘×•×™ ×”×ª×›×•× ×”:**

```env
OFFICEGUY_AUTO_CREATE_GUEST_USER=false
```

**×”×¢×¨×•×ª ×—×©×•×‘×•×ª:**

- ×× ×”××™××™×™×œ ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª, ×”×”×–×× ×” ×ª×§×•×©×¨ ×œ××©×ª××© ×”×§×™×™×
- ×”×¡×™×¡××” ×”×–×× ×™×ª × ×©×œ×—×ª ×¨×§ ×œ××©×ª××©×™× ×—×“×©×™×
- ××©×ª××©×™× ××—×•×‘×¨×™× ×œ× ××•×©×¤×¢×™× ××ª×›×•× ×” ×–×•
- ×”××™×™×œ × ×©×œ×— ×“×¨×š Queue ×œ×‘×™×¦×•×¢×™× ××™×˜×‘×™×™×
```

### 2. ×¢×“×›×•×Ÿ CHANGELOG.md

**File**: `/var/www/vhosts/nm-digitalhub.com/SUMIT-Payment-Gateway-for-laravel/CHANGELOG.md`

**×ª×•×›×Ÿ ×œ×”×•×¡×™×£**:

```markdown
## [v1.14.0] - 2025-12-07

### Added
- **Auto-Create User for Guest Payments**: ×”××¢×¨×›×ª ×™×•×¦×¨×ª ××•×˜×•××˜×™×ª ×—×©×‘×•×Ÿ ××©×ª××© ×¢×‘×•×¨ ××•×¨×—×™× ×œ××—×¨ ×ª×©×œ×•× ××•×¦×œ×—
  - Listener ×—×“×©: `AutoCreateUserListener` ×©×××–×™×Ÿ ×œ-`PaymentCompleted` event
  - Mailable ×—×“×©: `GuestWelcomeWithPasswordMail` ×œ××©×ª××©×™× ×—×“×©×™×
  - ×ª×‘× ×™×ª ××™×™×œ ×—×“×©×”: `guest-welcome-with-password.blade.php`
  - ×”×’×“×¨×•×ª ×—×“×©×•×ª: `auto_create_guest_user`, `guest_password_expiry_days`
  - ×™×¦×™×¨×ª ×¡×™×¡××” ×–×× ×™×ª (12 ×ª×•×•×™×, ×ª×•×§×£ 7 ×™××™×)
  - ×©×œ×™×—×ª ××™×™×œ ×¢× ×¤×¨×˜×™ ×”×ª×—×‘×¨×•×ª ×•×”×–×× ×”
  - ×§×™×©×•×¨ ××•×˜×•××˜×™ ×©×œ Order ×œ-User ×•×œ-Client

### Changed
- ×¢×“×›×•×Ÿ `OfficeGuyServiceProvider` ×œ×¨×™×©×•× `AutoCreateUserListener`

### Technical Details
- ×©×™××•×© ×‘××•×“×œ×™× ×§×™×™××™×: `User`, `Client`, `Order`
- ×©×™××•×© ×‘×˜×‘×œ××•×ª ×§×™×™××•×ª (××™×Ÿ ×¦×•×¨×š ×‘××™×’×¨×¦×™×•×ª)
- ×ª××™×›×” ×‘××§×¨×™× ×§×™×™××™×:
  - ××©×ª××© ×¢× email ×§×™×™× - ×§×™×©×•×¨ ×”×”×–×× ×” ×‘×œ×‘×“
  - ××©×ª××© ××—×•×‘×¨ - ××™×Ÿ ×¤×¢×•×œ×”
  - ××©×ª××© ××•×¨×— ×—×“×© - ×™×¦×™×¨×” ××œ××”
- Queued mail sending ×œ×‘×™×¦×•×¢×™×
- Comprehensive logging ×œ××¢×§×‘
```

### 3. ×¢×“×›×•×Ÿ CLAUDE.md

**File**: `/var/www/vhosts/nm-digitalhub.com/SUMIT-Payment-Gateway-for-laravel/CLAUDE.md`

**×ª×•×›×Ÿ ×œ×”×•×¡×™×£** (×‘×¡×¢×™×£ "Features"):

```markdown
- Auto-create user accounts for guest payments (v1.14.0+)
  - Automatic User creation after successful payment
  - Temporary password generation (12 chars, 7 days expiry)
  - Welcome email with login credentials
  - Automatic Client record creation
  - Order linking to User and Client
```

---

## âœ… ×¡×™×›×•× ×•××¡×§× ×•×ª

### ××” ×”×•×©×’ ×‘× ×™×ª×•×—

1. âœ… **×”×‘× ×” ××œ××” ×©×œ ×”××¢×¨×›×ª ×”×§×™×™××ª**
   - ×–×¨×™××ª ×”×ª×©×œ×•× ×‘-`PublicCheckoutController`
   - ××™×¨×•×¢ `PaymentCompleted` ×‘-`PaymentService`
   - ××•×“×œ×™×: `User`, `Client`, `Order`
   - ××¢×¨×›×ª ×¡×™×¡×××•×ª ×–×× ×™×•×ª ×§×™×™××ª

2. âœ… **×–×™×”×•×™ ×¨×›×™×‘×™× ×§×™×™××™× ×œ×©×™××•×© ×—×•×–×¨**
   - `CreateTemporaryPassword` action (×™×© ×œ×”×ª××™×)
   - `TemporaryPasswordMail` mailable (×™×© ×œ×”×ª××™×)
   - `Client::createFromUser()` method (××•×›×Ÿ ×œ×©×™××•×©)
   - `WelcomeNotification` (×œ× ××ª××™×, × ×¦×˜×¨×š ×—×“×©)

3. âœ… **×ª×›× ×•×Ÿ ×¤×ª×¨×•×Ÿ ××œ×**
   - Listener ×—×“×©: `AutoCreateUserListener`
   - Mailable ×—×“×©: `GuestWelcomeWithPasswordMail`
   - Email template ×—×“×©: `guest-welcome-with-password.blade.php`
   - ×”×’×“×¨×•×ª ×—×“×©×•×ª ×‘-config
   - ×¨×™×©×•× ×‘-ServiceProvider

4. âœ… **×–×™×”×•×™ ×¡×™×›×•× ×™× ×•××ª×’×¨×™×**
   - ×›×¤×™×œ×•×ª ××©×ª××©×™×
   - ×©×œ×™×—×ª ××™×™×œ×™× × ×›×©×œ×ª
   - ×ª×•×§×£ ×¡×™×¡×××•×ª
   - ×‘×™×¦×•×¢×™×

5. âœ… **×ª×›× ×•×Ÿ ×‘×“×™×§×•×ª ××§×™×£**
   - Unit tests
   - Feature tests
   - Manual testing checklist

### ×”×¦×¢×“×™× ×”×‘××™× (×œ××—×¨ ××™×©×•×¨)

1. **×©×œ×‘ 1: ×™×¦×™×¨×ª Listener**
   - ×™×¦×™×¨×ª `AutoCreateUserListener.php`
   - ×›×ª×™×‘×ª ×œ×•×’×™×§×ª ×”×™×¦×™×¨×”
   - ×˜×™×¤×•×œ ×‘×©×’×™××•×ª

2. **×©×œ×‘ 2: ×™×¦×™×¨×ª Mailable ×•-Template**
   - ×™×¦×™×¨×ª `GuestWelcomeWithPasswordMail.php`
   - ×™×¦×™×¨×ª ×ª×‘× ×™×ª HTML
   - ×‘×“×™×§×ª ×¢×™×¦×•×‘ ×•×ª×•×›×Ÿ

3. **×©×œ×‘ 3: ×¨×™×©×•× ×‘-ServiceProvider**
   - ×¢×“×›×•×Ÿ `OfficeGuyServiceProvider.php`
   - ×”×•×¡×¤×ª ×”×’×“×¨×•×ª ×‘-`config/officeguy.php`

4. **×©×œ×‘ 4: ×‘×“×™×§×•×ª**
   - ×›×ª×™×‘×ª Unit Tests
   - ×›×ª×™×‘×ª Feature Tests
   - ×‘×“×™×§×•×ª ×™×“× ×™×•×ª

5. **×©×œ×‘ 5: ×ª×™×¢×•×“**
   - ×¢×“×›×•×Ÿ README.md
   - ×¢×“×›×•×Ÿ CHANGELOG.md
   - ×¢×“×›×•×Ÿ CLAUDE.md

6. **×©×œ×‘ 6: Git Commit**
   - Commit ×¢× ×”×•×“×¢×” ××¤×•×¨×˜×ª
   - ×™×¦×™×¨×ª tag ×—×“×© (v1.14.0)
   - Push ×œ-GitHub
   - `composer update` ×‘××¢×¨×›×ª ×”×¨××©×™×ª

---

## ğŸ“‹ ××™×©×•×¨ ×”××©×š

**×”×× ×œ××©×¨ ×”××©×š ×œ×©×œ×‘ ×”×™×™×©×•×?**

×œ××—×¨ ×§×¨×™××ª ××¡××š ×”××™×¤×™×•×Ÿ, ×× ×™ ××‘×§×© ××™×©×•×¨ ×œ×”××©×™×š ×œ×™×¦×™×¨×ª ×”×§×•×“ ×”××œ×:

- [ ] ×××•×©×¨ - ×”××©×š ×œ×™×¦×™×¨×ª ×”×§×•×“
- [ ] ×“×¨×•×© ×©×™× ×•×™×™× - ×¤×¨×˜ ×œ××˜×”
- [ ] ×“×—×•×™ - ×”×¡×‘×¨ ×¡×™×‘×”

**×”×¢×¨×•×ª/×©×™× ×•×™×™× × ×“×¨×©×™×**:
_____________________________
_____________________________
_____________________________

---

**×¡×•×£ ××¡××š ××™×¤×™×•×Ÿ**

---

## ğŸ—„ï¸ × ×¡×¤×—: ××‘× ×™ ×˜×‘×œ××•×ª ×‘-DB (××•××ª×•)

### ×˜×‘×œ×ª `users`

**×©×“×•×ª ×¨×œ×•×•× ×˜×™×™× ×œ×ª×”×œ×™×š** (××•××ª×• ××”-DB):

| ×©×“×” | ×˜×™×¤×•×¡ | Null | ×‘×¨×™×¨×ª ××—×“×œ | ×”×¢×¨×•×ª |
|-----|-------|------|-----------|-------|
| `id` | bigint(20) unsigned | NO | auto_increment | PK |
| `name` | varchar(100) | NO | - | ×©× ××œ× |
| `email` | varchar(191) | NO | - | UNIQUE |
| `phone` | varchar(20) | YES | NULL | ×˜×œ×¤×•×Ÿ |
| `role` | enum | YES | 'client' | super_admin, admin, staff, client, reseller, viewer |
| `first_name` | varchar(255) | YES | NULL | ×©× ×¤×¨×˜×™ |
| `last_name` | varchar(255) | YES | NULL | ×©× ××©×¤×—×” |
| `company` | varchar(255) | YES | NULL | ×©× ×—×‘×¨×” |
| `address` | text | YES | NULL | ×›×ª×•×‘×ª |
| `city` | varchar(255) | YES | NULL | ×¢×™×¨ |
| `state` | varchar(255) | YES | NULL | ××“×™× ×”/××–×•×¨ |
| `country` | varchar(2) | YES | NULL | ×§×•×“ ××“×™× ×” (2 chars) |
| `postal_code` | varchar(255) | YES | NULL | ××™×§×•×“ |
| `vat_number` | varchar(255) | YES | NULL | ×—.×¤/×¢.× |
| `id_number` | varchar(255) | YES | NULL | ×ª.×– |
| `password` | varchar(255) | NO | - | Hashed |
| `email_verified_at` | timestamp | YES | NULL | ××™××•×ª ××™×™×œ |
| `has_temporary_password` | tinyint(1) | YES | NULL | âœ… ×¡×™×¡××” ×–×× ×™×ª? |
| `temporary_password_expires_at` | timestamp | YES | NULL | âœ… ×ª×•×§×£ ×¡×™×¡××” |
| `temporary_password_created_by` | varchar(255) | YES | NULL | âœ… ××™ ×™×¦×¨ (user_id) |
| `created_at` | timestamp | YES | NULL | - |
| `updated_at` | timestamp | YES | NULL | - |

**Key Findings**:
- âœ… `role` default = 'client' - ××•×©×œ× ×œ××©×ª××©×™× ×—×“×©×™×
- âœ… ×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™× ×§×™×™××™×
- âš ï¸ `temporary_password_created_by` = varchar(255) (×œ× bigint) - ×¦×¨×™×š ×œ×©××•×¨ string ××• NULL
- âœ… `country` = varchar(2) - ×§×•×“ ISO (IL, US, FR)

### ×˜×‘×œ×ª `clients`

**×©×“×•×ª ×¨×œ×•×•× ×˜×™×™×** (××•××ª×• ××”-DB):

| ×©×“×” | ×˜×™×¤×•×¡ | Null | ×‘×¨×™×¨×ª ××—×“×œ | ×”×¢×¨×•×ª |
|-----|-------|------|-----------|-------|
| `id` | bigint(20) unsigned | NO | auto_increment | PK |
| `user_id` | bigint(20) unsigned | YES | NULL | FK â†’ users.id |
| `name` | varchar(255) | YES | NULL | ×©× ×”×œ×§×•×— |
| `email` | varchar(255) | YES | NULL | ××™××™×™×œ |
| `client_name` | varchar(255) | YES | NULL | ×©× ××œ× (CardCom) |
| `client_email` | varchar(255) | YES | NULL | ××™××™×™×œ (CardCom) |
| `client_phone` | varchar(255) | YES | NULL | ×˜×œ×¤×•×Ÿ (CardCom) |
| `mobile_phone` | varchar(20) | YES | NULL | × ×™×™×“ |
| `id_number` | varchar(32) | YES | NULL | ×ª.×– |
| `card_owner_id` | varchar(9) | YES | NULL | ×ª.×– ×‘×¢×œ ×›×¨×˜×™×¡ |
| `first_name` | varchar(255) | YES | NULL | ×©× ×¤×¨×˜×™ |
| `last_name` | varchar(255) | YES | NULL | ×©× ××©×¤×—×” |
| `phone` | varchar(20) | YES | NULL | ×˜×œ×¤×•×Ÿ |
| `sumit_customer_id` | bigint(20) unsigned | YES | NULL | SUMIT customer ID |
| `sumit_last_sync` | timestamp | YES | NULL | ×¡× ×›×¨×•×Ÿ ××—×¨×•×Ÿ |
| `sumit_sync_status` | varchar(255) | NO | 'not_synced' | ×¡×˜×˜×•×¡ ×¡× ×›×¨×•×Ÿ |

**Key Findings**:
- âœ… `Client::createFromUser()` method ×›×‘×¨ ××˜×¤×œ ×‘×›×œ ×”×©×“×•×ª
- âœ… ×ª××™×›×” ×‘-CardCom fields (client_name, client_email, client_phone)
- âœ… ×ª××™×›×” ×‘-SUMIT customer sync

### ×˜×‘×œ×ª `orders`

**×©×“×•×ª ×¨×œ×•×•× ×˜×™×™×** (××•××ª×• ××”-DB):

| ×©×“×” | ×˜×™×¤×•×¡ | Null | ×‘×¨×™×¨×ª ××—×“×œ | ×”×¢×¨×•×ª |
|-----|-------|------|-----------|-------|
| `id` | bigint(20) unsigned | NO | auto_increment | PK |
| `user_id` | bigint(20) unsigned | YES | NULL | âœ… FK â†’ users.id |
| `client_id` | bigint(20) unsigned | YES | NULL | âœ… FK â†’ clients.id |
| `client_email` | varchar(255) | YES | NULL | âœ… Email of guest |
| `client_name` | varchar(255) | YES | NULL | âœ… Name of guest |
| `client_phone` | varchar(255) | YES | NULL | âœ… Phone of guest |
| `total_amount` | decimal | YES | NULL | ×¡×›×•× ×›×•×œ×œ |
| `billing_name` | varchar(255) | YES | NULL | ×©× ×œ×—×™×•×‘ |
| `billing_email` | varchar(255) | YES | NULL | ××™××™×™×œ ×œ×—×™×•×‘ |
| `billing_phone` | varchar(255) | YES | NULL | ×˜×œ×¤×•×Ÿ ×œ×—×™×•×‘ |
| `billing_address` | varchar(255) | YES | NULL | ×›×ª×•×‘×ª ×œ×—×™×•×‘ |
| `billing_city` | varchar(255) | YES | NULL | ×¢×™×¨ ×œ×—×™×•×‘ |
| `billing_state` | varchar(255) | YES | NULL | ××“×™× ×” ×œ×—×™×•×‘ |
| `billing_country` | varchar(255) | YES | NULL | ×§×•×“ ××“×™× ×” |
| `billing_zip` | varchar(255) | YES | NULL | ××™×§×•×“ |

**Key Findings**:
- âœ… `user_id` ×•-`client_id` nullable - ××•×©×œ× ×œ××•×¨×—×™×
- âœ… `client_email`, `client_name`, `client_phone` - × ×ª×•× ×™× ××™× ×™××œ×™×™× ×œ××©×ª××© ×—×“×©
- âœ… `billing_*` fields - × ×ª×•× ×™× × ×•×¡×¤×™× ××•×¤×¦×™×•× ×œ×™×™×
- âœ… ×”×”×–×× ×” ××›×™×œ×” ××ª ×›×œ ×”× ×ª×•× ×™× ×”× ×“×¨×©×™× ×œ×™×¦×™×¨×ª User + Client

---

## ğŸ” ×××¦××™× ×•×¢×“×›×•× ×™× ×œ××™×¤×™×•×Ÿ

### 1. ×©×“×” `temporary_password_created_by`

**×××¦×**: ×”×©×“×” ×”×•× `varchar(255)` ×•×œ× `bigint(20)`

**×”×©×œ×›×•×ª**:
- × ×©××•×¨ `null` ×‘××§×¨×” ×©×œ ××¢×¨×›×ª ××•×˜×•××˜×™×ª
- ××• × ×©××•×¨ string: `"system"` / `"auto_guest_payment"`

**×¢×“×›×•×Ÿ ×§×•×“**:
```php
$user = User::create([
    // ... other fields
    'temporary_password_created_by' => null, // ××•: 'system'
]);
```

### 2. ×©×“×” `country`

**×××¦×**: `varchar(2)` - ×§×•×“ ISO ×©×œ 2 ×ª×•×•×™×

**×”×©×œ×›×•×ª**:
- ×—×™×™×‘ ×œ×”×™×•×ª ×§×•×“ ISO: `IL`, `US`, `FR` ×•×›×•'
- ×œ× ×™×›×•×œ ×œ×”×™×•×ª `Israel` ××• `×™×©×¨××œ`

**×¢×“×›×•×Ÿ ×§×•×“**:
```php
'country' => $order->billing_country ?? 'IL', // ×‘×¨×™×¨×ª ××—×“×œ ×™×©×¨××œ
```

### 3. ××™×¤×•×™ ×©×“×•×ª Order â†’ User

**××™×¤×•×™ ××¢×•×“×›×Ÿ ×œ×¤×™ DB ×‘×¤×•×¢×œ**:

| Source (Order) | Target (User) | ×˜×™×¤×•×¡ | Null |
|----------------|---------------|-------|------|
| `client_name` ××• `billing_name` | `name` | varchar(100) | NO |
| `client_email` | `email` | varchar(191) | NO |
| `client_phone` ××• `billing_phone` | `phone` | varchar(20) | YES |
| Parse `client_name` | `first_name` | varchar(255) | YES |
| Parse `client_name` | `last_name` | varchar(255) | YES |
| `billing_name` | `company` | varchar(255) | YES |
| `billing_address` | `address` | text | YES |
| `billing_city` | `city` | varchar(255) | YES |
| `billing_state` | `state` | varchar(255) | YES |
| `billing_country` | `country` | varchar(2) | YES |
| `billing_zip` | `postal_code` | varchar(255) | YES |
| N/A | `id_number` | varchar(255) | YES |
| N/A | `vat_number` | varchar(255) | YES |
| `'client'` | `role` | enum | YES |

### 4. ××™×¤×•×™ ×©×“×•×ª User â†’ Client

**××™×¤×•×™ ××¢×•×“×›×Ÿ ×œ×¤×™ `Client::createFromUser()`**:

| Source (User) | Target (Client) | ×”×¢×¨×•×ª |
|---------------|-----------------|-------|
| `user->id` | `user_id` | FK |
| `user->name` | `name` | - |
| `user->email` | `email` | - |
| `first_name + last_name` | `client_name` | CardCom format |
| `user->email` | `client_email` | CardCom |
| `user->phone` | `client_phone` | CardCom |
| `user->id_number` | `card_owner_id` | CardCom (9 chars) |
| `user->first_name` | `first_name` | - |
| `user->last_name` | `last_name` | - |
| `user->phone` | `phone` | - |

---

## âœ… ×¡×™×›×•× ×××¦××™×

1. âœ… **×›×œ ×”×©×“×•×ª ×”× ×“×¨×©×™× ×§×™×™××™×** - ×œ× ×¦×¨×™×š migrations ×—×“×©×™×
2. âœ… **Default values ×ª×§×™× ×™×** - `role` = 'client' ××•×˜×•××˜×™×ª
3. âš ï¸ **`temporary_password_created_by`** - varchar(255), × ×©××•×¨ `null`
4. âš ï¸ **`country`** - ×—×™×™×‘ ×œ×”×™×•×ª ×§×•×“ ISO (2 chars)
5. âœ… **Orders ××›×™×œ×™× ××¡×¤×™×§ × ×ª×•× ×™×** - client_email, client_name, client_phone
6. âœ… **Client::createFromUser() ××•×›×Ÿ ×œ×©×™××•×©** - ×œ× ×¦×¨×™×š ×©×™× ×•×™×™×

---

**×¢×“×›×•×Ÿ ××—×¨×•×Ÿ**: 2025-12-07 16:00
**××•××ª ××•×œ**: MySQL DB `nmdigitalhub_v2`
