# ××¤×ª ×–×¨×™××” ××œ××”: Payment Flow End-to-End

**×ª××¨×™×š:** 2025-01-13
**××˜×¨×”:** ×ª×™×¢×•×“ ××§×™×£ ×©×œ ×ª×”×œ×™×š ×”×ª×©×œ×•× ×”××œ× ×-Checkout ×•×¢×“ ×™×¦×™×¨×ª ××¡××š

---

## ğŸ“Š ×¡×™×›×•× ×”× ×™×ª×•×—

×¡×”"×› × ×•×ª×—×• **5 Services ×¢×™×§×¨×™×™×** (3,107 ×©×•×¨×•×ª ×§×•×“):

| Service | ×©×•×¨×•×ª | ×ª×¤×§×™×“ | ×§×•×‘×¥ |
|---------|-------|-------|------|
| **PaymentService** | 1,178 | ×¢×™×‘×•×“ ×ª×©×œ×•××™× ×¨××©×™ | src/Services/PaymentService.php |
| **DocumentService** | 1,153 | ×™×¦×™×¨×ª ××¡××›×™× ×—×©×‘×•× ××™×™× | src/Services/DocumentService.php |
| **SettingsService** | 335 | × ×™×”×•×œ ×”×’×“×¨×•×ª (DBâ†’Configâ†’.env) | src/Services/SettingsService.php |
| **OfficeGuyApi** | 229 | HTTP Client ×œ-SUMIT API | src/Services/OfficeGuyApi.php |
| **TokenService** | 212 | × ×™×”×•×œ tokens (J2/J5) | src/Services/TokenService.php |
| **×¡×”"×›** | **3,107** | | |

---

## ğŸ¯ ×ª×¨×—×™×©×™ ×ª×©×œ×•× (Payment Scenarios)

×”×—×‘×™×œ×” ×ª×•××›×ª ×‘-**7 ×ª×¨×—×™×©×™×** ×©×•× ×™×:

1. **Direct Card Payment** - ×ª×©×œ×•× ×™×©×™×¨ ×‘×›×¨×˜×™×¡ (PCI='no')
2. **Redirect Payment** - ×”×¤× ×™×” ×œ×¢××•×“ ×ª×©×œ×•× SUMIT (PCI='redirect')
3. **PCI Direct** - ×›×¨×˜×™×¡ ×“×¨×š ×”×©×¨×ª (PCI='yes')
4. **Token Payment** - ×ª×©×œ×•× ×¢× saved payment method
5. **Subscription Payment** - ×—×™×•×‘ ×—×•×–×¨
6. **Third-Party Payment** - PayPal/BlueSnap â†’ Document only
7. **Multi-Vendor Payment** - ×ª×©×œ×•× ××‘×•×–×¨

---

## ğŸ”„ Flow 1: Direct Card Payment (PCI='no') - ×”××•××œ×¥

### ×ª×¨×©×™× ×–×¨×™××”:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          1. CHECKOUT PAGE LOAD                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ User visits checkout page     â”‚
                    â”‚ /officeguy/checkout/{orderId} â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ CheckoutController@show()     â”‚
                    â”‚ - Load order (Payable)        â”‚
                    â”‚ - Validate ownership          â”‚
                    â”‚ - Load PaymentsJS SDK         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      2. USER FILLS CARD DETAILS                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ PaymentsJS SDK (Hosted Fields)â”‚
                    â”‚ - Card validation in browser  â”‚
                    â”‚ - CVV validation              â”‚
                    â”‚ - Expiry validation           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ User clicks "Pay"
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ JavaScript: Generate Token    â”‚
                    â”‚ SUMIT.generateToken()         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ AJAX call
                                    â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  SUMIT API      â”‚
                           â”‚  Single-use     â”‚
                           â”‚  Token Created  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ Returns: sut_abc123
                                     â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ JavaScript receives token  â”‚
                    â”‚ POSTs to server:           â”‚
                    â”‚ - og-token: sut_abc123     â”‚
                    â”‚ - og-cvv: 123              â”‚
                    â”‚ - og-citizenid: 123456789  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    3. SERVER-SIDE PROCESSING                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ CheckoutController@store()    â”‚
                 â”‚ POST /officeguy/checkout/{id} â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ PaymentService::processCharge()       â”‚
                 â”‚                                        â”‚
                 â”‚ Step 1: Build Request                 â”‚
                 â”‚ â”œâ”€ getCredentials() â†’ SettingsService â”‚
                 â”‚ â”œâ”€ getOrderItems($order)              â”‚
                 â”‚ â”œâ”€ getOrderCustomer($order)           â”‚
                 â”‚ â”‚  â””â”€ Check sumit_customer_id        â”‚
                 â”‚ â”‚     â””â”€ If exists: ID only âœ…        â”‚
                 â”‚ â”œâ”€ buildPaymentMethod()               â”‚
                 â”‚ â”‚  â””â”€ SingleUseToken: sut_abc123     â”‚
                 â”‚ â””â”€ buildChargeRequest()               â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ OfficeGuyApi::post()          â”‚
                 â”‚ POST /creditguy/gateway/      â”‚
                 â”‚      transaction/             â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ 180s timeout
                                 â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   SUMIT API      â”‚
                       â”‚   Processing...  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Returns response
                              â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ Response Analysis:      â”‚
                 â”‚ Status = 0?             â”‚
                 â”‚ Data['Success'] = true? â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                             â”‚
         SUCCESS                       FAILURE
            â”‚                             â”‚
            â”‚                             â–¼
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚ PaymentFailed Event      â”‚
            â”‚              â”‚ - Log error              â”‚
            â”‚              â”‚ - Update order status    â”‚
            â”‚              â”‚ - Return error to user   â”‚
            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       4. SUCCESS PROCESSING                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PaymentService::processCharge() - SUCCESS    â”‚
â”‚                                               â”‚
â”‚ Step 1: Save Transaction                     â”‚
â”‚ â”œâ”€ OfficeGuyTransaction::createFromApiResponse() â”‚
â”‚ â”‚  â””â”€ transaction_id: TXN123                â”‚
â”‚ â”‚  â””â”€ payment_id: PAY456                    â”‚
â”‚ â”‚  â””â”€ sumit_entity_id: 789 â† CRITICAL!      â”‚
â”‚ â”‚  â””â”€ auth_number: 123456                   â”‚
â”‚ â”‚  â””â”€ amount: 100.0                         â”‚
â”‚ â”‚  â””â”€ status: completed                     â”‚
â”‚ â”‚  â””â”€ order_id + order_type (polymorphic)   â”‚
â”‚ â””â”€ Saved to officeguy_transactions table âœ…  â”‚
â”‚                                               â”‚
â”‚ Step 2: Create Token (if requested)          â”‚
â”‚ â”œâ”€ Extract Token from response               â”‚
â”‚ â”‚  â””â”€ CreditCard_Token: J5_abc123           â”‚
â”‚ â”œâ”€ TokenService::getTokenFromResponse()      â”‚
â”‚ â””â”€ OfficeGuyToken::createFromApiResponse()   â”‚
â”‚    â””â”€ token: J5_abc123                       â”‚
â”‚    â””â”€ last_four: 9012                        â”‚
â”‚    â””â”€ expiry_month/year                      â”‚
â”‚    â””â”€ owner_id + owner_type (polymorphic) âœ…  â”‚
â”‚                                               â”‚
â”‚ Step 3: Dispatch PaymentCompleted Event      â”‚
â”‚ â””â”€ Listeners:                                 â”‚
â”‚    â”œâ”€ FulfillmentListener â†’ Execute handlers â”‚
â”‚    â”œâ”€ DocumentSyncListener â†’ Create document â”‚
â”‚    â”œâ”€ CustomerSyncListener â†’ Sync customer   â”‚
â”‚    â”œâ”€ CrmActivitySyncListener â†’ Log to CRM   â”‚
â”‚    â””â”€ TransactionSyncListener â†’ Sync data    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    5. DOCUMENT GENERATION                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ DocumentSyncListener           â”‚
    â”‚ Triggered by PaymentCompleted  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ DocumentService::createOrderDocument() â”‚
    â”‚                                        â”‚
    â”‚ Step 1: Determine Document Type       â”‚
    â”‚ â”œâ”€ Check if donation                  â”‚
    â”‚ â”œâ”€ Type = 320 (donation receipt)      â”‚
    â”‚ â””â”€ Type = 8 (order)                   â”‚
    â”‚                                        â”‚
    â”‚ Step 2: Build Request                 â”‚
    â”‚ â”œâ”€ Items: getDocumentOrderItems()     â”‚
    â”‚ â”œâ”€ Customer: from PaymentService      â”‚
    â”‚ â”œâ”€ VATIncluded: true                  â”‚
    â”‚ â”œâ”€ Currency: ILS/USD/EUR              â”‚
    â”‚ â””â”€ Language: he/en/fr                 â”‚
    â”‚                                        â”‚
    â”‚ Step 3: Call SUMIT API                â”‚
    â”‚ â””â”€ POST /accounting/documents/create/ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   SUMIT API     â”‚
           â”‚   Creates Doc   â”‚
           â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ Returns: DocumentID + CustomerID
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ OfficeGuyDocument::            â”‚
    â”‚   createFromApiResponse()      â”‚
    â”‚                                â”‚
    â”‚ - document_id: 12345           â”‚
    â”‚ - document_number: INV-001     â”‚
    â”‚ - customer_id: 67890           â”‚
    â”‚ - order_id: 123                â”‚
    â”‚ - order_type: Order::class     â”‚
    â”‚ - document_type: 8             â”‚
    â”‚ - amount: 100.0                â”‚
    â”‚ - raw_response: {...}          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ DocumentCreated Event          â”‚
    â”‚ - Dispatch webhooks            â”‚
    â”‚ - Send email (if configured)   â”‚
    â”‚ - Log to activity feed         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     6. FULFILLMENT EXECUTION                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ FulfillmentListener            â”‚
    â”‚ Triggered by PaymentCompleted  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ FulfillmentDispatcher::dispatch()     â”‚
    â”‚                                        â”‚
    â”‚ Step 1: Get Payable fulfillment_type  â”‚
    â”‚ â””â”€ $order->getFulfillmentType()       â”‚
    â”‚    â”œâ”€ 'generic'                       â”‚
    â”‚    â”œâ”€ 'digital'                       â”‚
    â”‚    â”œâ”€ 'infrastructure'                â”‚
    â”‚    â””â”€ 'subscription'                  â”‚
    â”‚                                        â”‚
    â”‚ Step 2: Resolve Handler               â”‚
    â”‚ â””â”€ GenericFulfillmentHandler          â”‚
    â”‚    DigitalProductFulfillmentHandler   â”‚
    â”‚    InfrastructureFulfillmentHandler   â”‚
    â”‚    SubscriptionFulfillmentHandler     â”‚
    â”‚                                        â”‚
    â”‚ Step 3: Execute Handler               â”‚
    â”‚ â””â”€ $handler->handle($order, $txn)     â”‚
    â”‚    â”œâ”€ Activate service                â”‚
    â”‚    â”œâ”€ Send credentials                â”‚
    â”‚    â”œâ”€ Provision infrastructure        â”‚
    â”‚    â””â”€ Log fulfillment                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     7. REDIRECT TO SUCCESS                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SecureSuccessUrlGenerator::generate() â”‚
    â”‚                                        â”‚
    â”‚ - Create OrderSuccessToken            â”‚
    â”‚ - Generate secure URL with token      â”‚
    â”‚ - Set expiration (1 hour)             â”‚
    â”‚ - Log access                          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Redirect to:                â”‚
    â”‚ /success?token=abc123def456 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ SecureSuccessController      â”‚
    â”‚ - Validate token             â”‚
    â”‚ - Show order details         â”‚
    â”‚ - Show document download     â”‚
    â”‚ - Show fulfillment info      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flow 2: Token Payment (Saved Payment Method)

### ×ª×¨×©×™× ×–×¨×™××” ××§×•×¦×¨:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        User selects saved card               â”‚
â”‚        Card ending in 9012                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JavaScript prompts for CVV                   â”‚
â”‚ (Security requirement - CVV not stored)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼ POSTs: token_id + cvv
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CheckoutController@store()                   â”‚
â”‚                                               â”‚
â”‚ Step 1: Validate Token Ownership â† CRITICAL! â”‚
â”‚ â”œâ”€ $token = OfficeGuyToken::find($tokenId)  â”‚
â”‚ â”œâ”€ if ($token->owner_id !== $user->id)      â”‚
â”‚ â”‚  â””â”€ abort(403) â† Security violation!      â”‚
â”‚ â””â”€ OK âœ…                                      â”‚
â”‚                                               â”‚
â”‚ Step 2: Build PaymentMethod                  â”‚
â”‚ â”œâ”€ TokenService::getPaymentMethodFromToken() â”‚
â”‚ â””â”€ [                                         â”‚
â”‚      'CreditCard_Token' => 'J5_abc123',      â”‚
â”‚      'CreditCard_CVV' => '123', â† User input â”‚
â”‚      'CreditCard_CitizenID' => '123456789',  â”‚
â”‚      'CreditCard_ExpirationMonth' => '12',   â”‚
â”‚      'CreditCard_ExpirationYear' => '2025',  â”‚
â”‚      'Type' => 1,                            â”‚
â”‚    ]                                          â”‚
â”‚                                               â”‚
â”‚ Step 3: Process Payment                      â”‚
â”‚ â””â”€ PaymentService::processCharge()          â”‚
â”‚    â†’ Same flow as Direct Payment âœ…          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Security Critical:**
- Token ownership MUST be validated
- CVV always required from user (never stored)
- Token expiry check recommended

---

## ğŸ”„ Flow 3: Subscription Payment (Recurring Billing)

### ×ª×¨×©×™× ×–×¨×™××”:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ProcessRecurringPaymentsJob                 â”‚
â”‚     Scheduled: Daily (or custom frequency)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SubscriptionService::processDueSubscriptions()  â”‚
â”‚                                                  â”‚
â”‚ Query: Subscriptions WHERE                      â”‚
â”‚ - status = 'active'                             â”‚
â”‚ - next_billing_at <= now()                      â”‚
â”‚ - has valid token                               â”‚
â”‚ - subscriber has sumit_customer_id              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ For each subscription:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SubscriptionService::chargeSubscription()       â”‚
â”‚                                                  â”‚
â”‚ Step 1: Get Token                               â”‚
â”‚ â”œâ”€ $token = $subscription->paymentMethod        â”‚
â”‚ â”œâ”€ Validate token not expired                   â”‚
â”‚ â””â”€ Build PaymentMethod array                    â”‚
â”‚                                                  â”‚
â”‚ Step 2: Build Request                           â”‚
â”‚ â”œâ”€ Customer: [ID => sumit_customer_id] â† ID ONLYâ”‚
â”‚ â”œâ”€ Items: [                                     â”‚
â”‚ â”‚    Name => $subscription->name,               â”‚
â”‚ â”‚    Amount => $subscription->amount,           â”‚
â”‚ â”‚  ]                                             â”‚
â”‚ â”œâ”€ ExternalReference:                           â”‚
â”‚ â”‚  'subscription_' . $sub->id . '_recurring_'   â”‚
â”‚ â”‚   . $sub->recurring_id                        â”‚
â”‚ â””â”€ Currency: $subscription->currency            â”‚
â”‚                                                  â”‚
â”‚ Step 3: Process Payment                         â”‚
â”‚ â””â”€ PaymentService::processCharge()              â”‚
â”‚    â”œâ”€ Call SUMIT API                            â”‚
â”‚    â”œâ”€ Create Transaction                        â”‚
â”‚    â””â”€ Dispatch Events                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                     â”‚
SUCCESS               FAILURE
   â”‚                     â”‚
   â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SUCCESS:    â”‚    â”‚ FAILURE:        â”‚
â”‚ - Update    â”‚    â”‚ - Increment     â”‚
â”‚   next_     â”‚    â”‚   failed_       â”‚
â”‚   billing_  â”‚    â”‚   payments      â”‚
â”‚   at        â”‚    â”‚ - Dispatch      â”‚
â”‚ - Reset     â”‚    â”‚   event         â”‚
â”‚   failed_   â”‚    â”‚ - Retry logic   â”‚
â”‚   payments  â”‚    â”‚ - Pause after   â”‚
â”‚ - Create    â”‚    â”‚   max retries   â”‚
â”‚   document  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ - Dispatch  â”‚
â”‚   event     â”‚
â”‚ - Send      â”‚
â”‚   email     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Points:**
- Runs as scheduled job (Laravel scheduler)
- Uses saved tokens (no user interaction)
- ExternalReference tracks recurring charges
- Auto-pause after max failures
- Documents auto-created with subscription reference

---

## ğŸ”„ Flow 4: Third-Party Payment (PayPal/BlueSnap)

### ×ª×¨×©×™× ×–×¨×™××”:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User pays via PayPal                â”‚
â”‚  (External gateway)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ Webhook/Callback
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Application Payment Handler                      â”‚
â”‚ (Not part of SUMIT package)                      â”‚
â”‚                                                  â”‚
â”‚ - Mark order as paid                            â”‚
â”‚ - Get transaction ID from PayPal                â”‚
â”‚ - Update order status                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ Call SUMIT package:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DocumentService::createDocumentOnPaymentComplete()â”‚
â”‚                                                   â”‚
â”‚ Step 1: Check if enabled                         â”‚
â”‚ â”œâ”€ config('officeguy.paypal_receipts')          â”‚
â”‚ â”‚  â””â”€ If 'no' â†’ Skip document creation âœ…       â”‚
â”‚ â””â”€ If 'yes' â†’ Continue                          â”‚
â”‚                                                   â”‚
â”‚ Step 2: Build Request                            â”‚
â”‚ â”œâ”€ Type: '1' (Invoice - always)                 â”‚
â”‚ â”œâ”€ Items: from order                            â”‚
â”‚ â”œâ”€ Customer: from order                         â”‚
â”‚ â”œâ”€ Payments: [                                   â”‚
â”‚ â”‚    Details_Other: [                            â”‚
â”‚ â”‚      Type: 'Laravel',                          â”‚
â”‚ â”‚      Description: 'PayPal - TXN123',          â”‚
â”‚ â”‚      DueDate: now(),                           â”‚
â”‚ â”‚    ]                                            â”‚
â”‚ â”‚  ]                                              â”‚
â”‚ â””â”€ SendByEmail: true (if enabled)               â”‚
â”‚                                                   â”‚
â”‚ Step 3: Create Document                          â”‚
â”‚ â””â”€ OfficeGuyApi::post()                         â”‚
â”‚    POST /accounting/documents/create/            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Document Created                     â”‚
â”‚ - Save to officeguy_documents        â”‚
â”‚ - Link to order (polymorphic)        â”‚
â”‚ - Dispatch DocumentCreated event     â”‚
â”‚ - Email sent by SUMIT âœ…             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Configuration:**
```php
// config/officeguy.php
'paypal_receipts' => 'yes',      // Enable PayPal documents
'bluesnap_receipts' => true,     // Enable BlueSnap documents
'other_receipts' => 'stripe',    // Custom payment method
```

**When to Use:**
- Payment processed outside SUMIT
- Need accounting document only
- No SUMIT transaction ID (uses payment description)

---

## ğŸ“Š Service Dependencies Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     CHECKOUT LAYER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ PublicCheckoutController / CheckoutController           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                      â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SERVICE LAYER                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚           PaymentService (1,178 lines)               â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”‚
â”‚  â”‚  â”‚ - processCharge()                          â”‚     â”‚     â”‚
â”‚  â”‚  â”‚ - processResolvedIntent()                  â”‚     â”‚     â”‚
â”‚  â”‚  â”‚ - buildChargeRequest()                     â”‚     â”‚     â”‚
â”‚  â”‚  â”‚ - getOrderCustomer() â† Deduplication!      â”‚     â”‚     â”‚
â”‚  â”‚  â”‚ - getOrderItems()                          â”‚     â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚               â”‚                                                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚      â”‚        â”‚        â”‚            â”‚             â”‚           â”‚
â”‚      â–¼        â–¼        â–¼            â–¼             â–¼           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚Settingsâ”‚ â”‚API â”‚ â”‚ Token  â”‚ â”‚Documentâ”‚ â”‚Fulfillmentâ”‚      â”‚
â”‚  â”‚Service â”‚ â”‚    â”‚ â”‚Service â”‚ â”‚Service â”‚ â”‚Dispatcher â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚     335      229       212       1,153         150            â”‚
â”‚    lines    lines     lines     lines        lines            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DATA LAYER                                  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ OfficeGuyApi (229 lines)                             â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”‚
â”‚  â”‚  â”‚ - post() â†’ HTTP Client wrapper             â”‚     â”‚     â”‚
â”‚  â”‚  â”‚ - postRaw() â†’ Actual HTTP implementation   â”‚     â”‚     â”‚
â”‚  â”‚  â”‚ - Timeout: 180s                            â”‚     â”‚     â”‚
â”‚  â”‚  â”‚ - SSL Verify: configurable                 â”‚     â”‚     â”‚
â”‚  â”‚  â”‚ - Logging: optional                        â”‚     â”‚     â”‚
â”‚  â”‚  â”‚ - Error handling: graceful                 â”‚     â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                     â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚      SUMIT API           â”‚
         â”‚  https://api.sumit.co.il â”‚
         â”‚  - /creditguy/gateway/   â”‚
         â”‚  - /accounting/documents/â”‚
         â”‚  - /creditguy/vault/     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ Security Checkpoints

### Checkpoint 1: Configuration Validation
```php
// SettingsService (3-layer priority)
DB (officeguy_settings) â†’ Config â†’ .env

// Critical settings:
- company_id: MUST be set
- private_key: MUST be set (never exposed to client!)
- public_key: For hosted fields (client-side)
- environment: www/dev/test
- ssl_verify: MUST be true in production
```

### Checkpoint 2: Token Ownership Validation
```php
// TokenService has NO validation!
// Calling code MUST validate:
$token = OfficeGuyToken::find($tokenId);

if ($token->owner_id !== $user->id ||
    $token->owner_type !== get_class($user)) {
    abort(403, 'Unauthorized');  // â† CRITICAL!
}
```

### Checkpoint 3: Customer Duplication Prevention
```php
// PaymentService::getOrderCustomer()
if ($sumitCustomerId = $order->getSumitCustomerId()) {
    return ['ID' => (int) $sumitCustomerId];  // â† ID ONLY!
}
// Full customer data only if no ID

// Safety guard in buildChargeRequest():
if (isset($request['Customer']['ID'])) {
    $request['Customer'] = ['ID' => $request['Customer']['ID']];
}
```

### Checkpoint 4: Webhook Confirmation
```php
// OfficeGuyTransaction MUST have sumit_entity_id!
'sumit_entity_id' => $response['EntityID'] ?? null,

// Without this â†’ Webhooks can't match transactions
// Result: Duplicate charges or lost confirmations
```

### Checkpoint 5: Document-Order Linking
```php
// OfficeGuyDocument::createFromApiResponse()
OfficeGuyDocument::createFromApiResponse(
    $orderId,
    $response,
    $request,
    get_class($order)  // â† CRITICAL: order_type for polymorphic
);

// Without order_type â†’ Document orphaned!
```

---

## ğŸ“Š Error Handling Strategies

### Strategy 1: Graceful Degradation (OfficeGuyApi)
```php
// All errors return null (not throw exception)
$response = OfficeGuyApi::post($request, $endpoint, $env);

if ($response === null) {
    // Connection failed / Timeout / Server error
    // Calling code decides: retry, fail, fallback
}
```

### Strategy 2: Database-First Fallback (SettingsService)
```php
// Try DB â†’ Try Config â†’ Return default
try {
    if (OfficeGuySetting::has($key)) {
        return OfficeGuySetting::get($key);  // DB wins
    }
} catch (\Exception $e) {
    // DB failed â†’ fallback to config
}

return config("officeguy.{$key}", $default);
```

### Strategy 3: Event-Based Recovery (PaymentService)
```php
// Dispatch events for both success AND failure
if ($success) {
    event(new PaymentCompleted($transaction));
} else {
    event(new PaymentFailed($order, $error));
}

// Listeners can retry, log, alert, etc.
```

### Strategy 4: Transaction Logging (All Services)
```php
// ALWAYS log transaction before processing
OfficeGuyTransaction::create([
    'status' => 'pending',  // â† Start as pending
    'raw_request' => $request,
    // ...
]);

// Update after response:
$transaction->update([
    'status' => $success ? 'completed' : 'failed',
    'raw_response' => $response,
]);

// Provides audit trail + recovery path
```

---

## ğŸ¯ Critical Success Factors

### Factor 1: Polymorphic Relationships
**All entities use polymorphic relationships:**

```php
// OfficeGuyTransaction
'order_id' => 123,
'order_type' => 'App\Models\Order',  // â† CRITICAL!

// OfficeGuyToken
'owner_id' => 456,
'owner_type' => 'App\Models\User',  // â† CRITICAL!

// OfficeGuyDocument
'order_id' => 789,
'order_type' => 'App\Models\Subscription',  // â† CRITICAL!
```

**Why Critical:**
- Without `order_type` â†’ Can't load relationships
- Without `owner_type` â†’ Token ownership unclear
- Enables: `$transaction->order`, `$token->owner`, `$document->order`

### Factor 2: SUMIT Entity ID
```php
// OfficeGuyTransaction MUST store:
'sumit_entity_id' => $response['EntityID'] ?? null,

// This is THE key for webhook matching!
// SUMIT webhooks include EntityID
// Without it â†’ Can't match webhook to transaction
```

### Factor 3: Customer Deduplication
```php
// If customer exists in SUMIT:
'Customer' => ['ID' => 12345]  // â† ID ONLY!

// If new customer:
'Customer' => [
    'Name' => 'John Doe',
    'Email' => 'john@example.com',
    // ... full details
]

// Safety guard prevents duplicates
```

### Factor 4: Configuration Priority
```php
// 3-Layer Priority (ALWAYS):
1. Database (officeguy_settings) â† HIGHEST
2. Config file (config/officeguy.php)
3. .env (OFFICEGUY_*) â† Fallback

// ServiceProvider::boot() merges DB â†’ Config
// Result: config() includes DB overrides âœ…
```

---

## ğŸ“ˆ Performance Optimizations

### Optimization 1: Settings Caching (SettingsService)
```php
// Cache table existence check
protected static ?bool $tableExistsCache = null;

// Without cache: 74 x Schema::hasTable() per request
// With cache: 1 x Schema::hasTable() per request
```

### Optimization 2: Batch Settings Loading (SettingsService)
```php
// Load all DB settings in 1 query
$dbSettings = OfficeGuySetting::getAllSettings();  // 1 query

// Instead of 74 separate queries:
foreach ($keys as $key) {
    $value = OfficeGuySetting::get($key);  // 74 queries!
}
```

### Optimization 3: Pagination (DocumentService)
```php
// Fetch 1000 documents per page
$pageSize = 1000;

// With HasNextPage detection
while ($hasMoreResults) {
    // Fetch page
    $hasMoreResults = $response['Data']['HasNextPage'] ?? false;
}

// Safety limit: 100K documents max
```

### Optimization 4: Subscription Matching (DocumentService)
```php
// Fetch ALL subscriptions once (not per item)
$subscriptions = Subscription::query()
    ->where(/* filters */)
    ->get();  // 1 query

// Then match in memory:
foreach ($items as $item) {
    foreach ($subscriptions as $subscription) {
        // In-memory matching âœ…
    }
}

// Instead of: N items x M queries
```

---

## ğŸ“ Summary

×¡×”"×› × ×•×ª×—×• **5 Services ×§×¨×™×˜×™×™×** (3,107 ×©×•×¨×•×ª):

1. **PaymentService** (1,178) - Core payment processing
2. **DocumentService** (1,153) - Accounting documents
3. **SettingsService** (335) - Configuration management
4. **OfficeGuyApi** (229) - HTTP Client
5. **TokenService** (212) - Token management

**××¤×ª ×”×–×¨×™××” ××¨××”:**
- 7 ×ª×¨×—×™×©×™ ×ª×©×œ×•× ×©×•× ×™×
- 5 Checkpoints ××‘×˜×—×” ×§×¨×™×˜×™×™×
- 4 ××¡×˜×¨×˜×’×™×•×ª error handling
- 4 ×’×•×¨××™ ×”×¦×œ×—×” ×§×¨×™×˜×™×™×
- 4 optimizations ×‘×™×¦×•×¢×™×

**×”××¢×¨×›×ª ××‘×•×¡×¡×ª ×¢×œ:**
- Polymorphic relationships (order_type, owner_type)
- Event-driven architecture (18 events, 8 listeners)
- 3-layer configuration (DB â†’ Config â†’ .env)
- Graceful degradation (null returns, not exceptions)
- Intelligent deduplication (customer, subscription matching)

---

**× ×•×¦×¨:** 2025-01-13
**×¡×”"×› ×§×•×“ × ×•×ª×—:** 3,107 ×©×•×¨×•×ª
**×–××Ÿ × ×™×ª×•×—:** ~2 ×©×¢×•×ª
